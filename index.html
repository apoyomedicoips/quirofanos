<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablero de Quirófanos - Ministerio de Trabajo</title>

    <!-- Bootstrap y dependencias visuales -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>

    <!-- DataTables -->
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <style>
        :root {
            --bg-main: #0f172a;
            --bg-panel: #1e293b;
            --bg-card: #334155;
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
            --accent: #38bdf8;
            --border-col: #475569;
            --radius-lg: 1rem;
            --radius-sm: 0.5rem;
            --font-main: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",sans-serif;
        }
        body {
            background-color: var(--bg-main);
            color: var(--text-main);
            font-family: var(--font-main);
            margin: 0;
            line-height: 1.4;
        }
        .dashboard-header {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-bottom: 1px solid var(--border-col);
        }
        .card {
            background-color: var(--bg-panel);
            border: 1px solid var(--border-col);
            border-radius: var(--radius-lg);
            margin-bottom: 20px;
            transition: transform 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .card:hover { transform: translateY(-5px); }
        .card-header {
            background-color: var(--bg-card);
            color: var(--text-main);
            border-bottom: 1px solid var(--border-col);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0 !important;
        }
        .stat-card {
            text-align: center;
            padding: 20px;
            border-radius: var(--radius-lg);
            color: white;
            margin-bottom: 20px;
            transition: transform 0.3s;
            background-color: var(--bg-card);
            border: 1px solid var(--border-col);
            display: flex;
            flex-direction: column;
            min-height: 120px;
            justify-content: space-between;
        }
        .stat-card:hover { transform: translateY(-5px); }
        .kpi-label {
            font-size: 0.75rem;
            color: var(--text-dim);
            font-weight: 500;
        }
        .kpi-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--accent);
        }
        .kpi-foot {
            font-size: 0.7rem;
            color: var(--text-dim);
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }
        .table-container {
            max-height: 500px;
            overflow-y: auto;
        }
        .filter-section {
            background-color: var(--bg-panel);
            padding: 15px;
            border-radius: var(--radius-lg);
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 1px solid var(--border-col);
        }
        .loading {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(15, 23, 42, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--bg-card);
            border-top: 5px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }
        .nav-tabs .nav-link.active {
            background-color: var(--accent);
            color: var(--bg-main);
            border-color: var(--accent);
        }
        .nav-tabs .nav-link {
            color: var(--accent);
            background-color: var(--bg-panel);
            border-color: var(--border-col);
        }
        .data-quality-alert {
            background-color: rgba(55, 65, 81, 0.8);
            border: 1px solid var(--border-col);
            border-radius: var(--radius-sm);
            padding: 10px;
            margin-bottom: 20px;
        }
        .btn-primary {
            background-color: var(--accent);
            border-color: var(--accent);
            color: var(--bg-main);
        }
        .btn-secondary {
            background-color: var(--bg-card);
            border-color: var(--border-col);
            color: var(--text-main);
        }
        .form-control,
        .form-select {
            background-color: var(--bg-card);
            border: 1px solid var(--border-col);
            color: var(--text-main);
        }
        .form-control:focus,
        .form-select:focus {
            background-color: var(--bg-card);
            border-color: var(--accent);
            color: var(--text-main);
            box-shadow: 0 0 0 0.25rem rgba(56,189,248,0.25);
        }
        .table { color: var(--text-main); }
        .table thead th {
            background-color: var(--bg-card);
            border-bottom: 1px solid var(--border-col);
            color: var(--text-dim);
            font-weight: 600;
            font-size: 0.8rem;
        }
        .table tbody tr:hover { background-color: rgba(56,189,248,0.1); }
        .table tbody td { border-bottom: 1px solid var(--border-col); }
        footer {
            background-color: var(--bg-panel);
            border-top: 1px solid var(--border-col);
            padding: 20px;
            margin-top: 40px;
            color: var(--text-dim);
            font-size: 0.8rem;
            text-align: center;
        }
        .user-info {
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-top: 5px;
        }
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
        }
        .login-card {
            background-color: var(--bg-panel);
            border: 1px solid var(--border-col);
            border-radius: var(--radius-lg);
            padding: 2rem;
            width: 320px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.7);
        }
        .login-error {
            background-color: rgba(127, 29, 29, 0.8);
            border: 1px solid #dc2626;
            color: #fecaca;
            font-size: 0.8rem;
            border-radius: var(--radius-sm);
            padding: 0.5rem 0.75rem;
            margin-bottom: 1rem;
            text-align: center;
            word-break: break-word;
        }
        .chart-note {
            font-size: 0.7rem;
            color: var(--text-dim);
            margin-top: 0.5rem;
            line-height: 1.3;
        }
        .footnote {
            font-size: 0.7rem;
            color: var(--text-dim);
            margin-top: 0.5rem;
        }
        .kpi-warning {
            color: #f87171 !important;
        }
        .kpi-success {
            color: #4ade80 !important;
        }
        .title-with-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .title-with-info h5 {
            margin-bottom: 0;
        }
        .kpi-label-with-info {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            justify-content: center;
        }
    </style>
</head>
<body>

<!-- Pantalla de Login -->
<div id="loginScreen" class="login-container" style="display:flex;">
    <div class="login-card">
        <h1 class="text-center mb-4">Ingreso al Tablero de Quirófanos</h1>

        <div id="loginError" class="login-error" style="display:none;"></div>

        <form id="loginForm">
            <div class="mb-3">
                <label for="usuario" class="form-label">Usuario</label>
                <input type="text" class="form-control" id="usuario" required>
            </div>
            <div class="mb-3">
                <label for="codigo" class="form-label">Código de acceso</label>
                <input type="password" class="form-control" id="codigo" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">
                Acceder
            </button>
        </form>

        <div class="user-info mt-4 text-center">
            Acceso restringido. Ministerio de Trabajo, Empleo y Seguridad Social.<br>
            Área de Apoyo Médico IPS.
        </div>
    </div>
</div>

<!-- Pantalla Principal del Tablero -->
<div id="dashboardScreen" style="display:none;">
    <div class="container-fluid">
        <div class="dashboard-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="mb-1">
                        <i class="bi bi-graph-up"></i> Tablero de Consumo de Kits en Quirófano
                    </h1>
                    <div class="user-info">
                        Usuario activo: <span id="activeUser"></span><br>
                        Datos internos, acceso restringido. Sesión temporal.
                    </div>
                </div>
                <div>
                    <button class="btn btn-outline-light" id="logoutBtn">
                        <i class="bi bi-box-arrow-right"></i> Cerrar Sesión
                    </button>
                </div>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
        </div>

        <div class="data-quality-alert" id="dataQualityAlert" style="display:none;">
            <h5><i class="bi bi-exclamation-triangle-fill"></i> Alerta de Calidad de Datos</h5>
            <p id="dataQualityMessage"></p>
        </div>

        <div class="filter-section">
            <div class="row">
                <div class="col-md-2">
                    <label for="filtroDesde" class="form-label">Desde, fecha</label>
                    <input type="date" class="form-control" id="filtroDesde">
                </div>
                <div class="col-md-2">
                    <label for="filtroHasta" class="form-label">Hasta, fecha</label>
                    <input type="date" class="form-control" id="filtroHasta">
                </div>
                <div class="col-md-2">
                    <label for="filtroFarmacia" class="form-label">Farmacia / Almacén</label>
                    <select class="form-select" id="filtroFarmacia">
                        <option value="__ALL__">Todas</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="filtroTurno" class="form-label">Turno</label>
                    <select class="form-select" id="filtroTurno">
                        <option value="__ALL__">Todos</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="filtroTipo" class="form-label">Tipo</label>
                    <select class="form-select" id="filtroTipo">
                        <option value="__ALL__">Todos</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="filtroQuirofano" class="form-label">Quirófano</label>
                    <select class="form-select" id="filtroQuirofano">
                        <option value="__ALL__">Todos</option>
                    </select>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-3">
                    <label for="filtroKit" class="form-label">Kit</label>
                    <select class="form-select" id="filtroKit">
                        <option value="__ALL__">Todos</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="filtroEspecialidad" class="form-label">Especialidad</label>
                    <select class="form-select" id="filtroEspecialidad">
                        <option value="__ALL__">Todas</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="filtroNombre" class="form-label">Nombre Personal</label>
                    <select class="form-select" id="filtroNombre">
                        <option value="__ALL__">Todos</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="filtroUsuario" class="form-label">Usuario</label>
                    <select class="form-select" id="filtroUsuario">
                        <option value="__ALL__">Todos</option>
                    </select>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-3 d-flex align-items-end">
                    <button class="btn btn-secondary w-100" id="btnReset">
                        <i class="bi bi-arrow-clockwise"></i> Limpiar filtros
                    </button>
                </div>
            </div>
        </div>

        <!-- KPIs Principales -->
        <div class="row">
            <div class="col-md-2">
                <div class="stat-card">
                    <div class="kpi-label-with-info">
                        <span class="kpi-label">Procedimientos totales</span>
                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Número total de procedimientos quirúrgicos registrados en el período filtrado. Este KPI representa el volumen general de actividad en los quirófanos, permitiendo evaluar la carga operativa y comparar con períodos anteriores para detectar tendencias de crecimiento o disminución en la demanda de servicios quirúrgicos."></i>
                    </div>
                    <div class="kpi-value" id="kpiProcedimientos">0</div>
                    <div class="kpi-foot">En período filtrado</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stat-card">
                    <div class="kpi-label-with-info">
                        <span class="kpi-label">Eficiencia quirófano</span>
                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Porcentaje de utilización de recursos en quirófanos, calculado como el promedio de procedimientos por quirófano por día. Valores superiores al 80% indican una alta eficiencia y óptimo uso de instalaciones; valores inferiores al 60% sugieren posible subutilización, cuellos de botella o necesidad de ajustes en programación. Este KPI es clave para optimizar recursos y reducir tiempos de espera."></i>
                    </div>
                    <div class="kpi-value" id="kpiEficiencia">0%</div>
                    <div class="kpi-foot">Uso de recursos</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stat-card">
                    <div class="kpi-label-with-info">
                        <span class="kpi-label">Kits por procedimiento</span>
                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Promedio de kits consumidos por cada procedimiento registrado. Este indicador ayuda a evaluar la eficiencia en el uso de materiales; valores elevados podrían señalar desperdicio, variabilidad en protocolos o casos de mayor complejidad, mientras que valores bajos indican optimización. Monitorearlo permite identificar oportunidades para estandarizar procesos y reducir costos."></i>
                    </div>
                    <div class="kpi-value" id="kpiKitsPorProc">0.0</div>
                    <div class="kpi-foot">Promedio</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stat-card">
                    <div class="kpi-label-with-info">
                        <span class="kpi-label">Turno más activo</span>
                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Turno con el mayor volumen de procedimientos (por ejemplo, mañana, tarde o noche). Este KPI es útil para la planificación de recursos humanos y materiales, permitiendo asignar personal adicional o ajustar horarios para equilibrar la carga y mejorar la eficiencia operativa durante picos de actividad."></i>
                    </div>
                    <div class="kpi-value" id="kpiTurnoActivo">-</div>
                    <div class="kpi-foot">Por volumen</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stat-card">
                    <div class="kpi-label-with-info">
                        <span class="kpi-label">Tasa de suspensión</span>
                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Porcentaje de procedimientos suspendidos respecto al total registrado. Valores superiores al 10% pueden indicar problemas logísticos, falta de preparación o issues con suministros/pacientes. Analizar este KPI ayuda a identificar causas raíz y implementar medidas preventivas para minimizar interrupciones y mejorar la continuidad del servicio."></i>
                    </div>
                    <div class="kpi-value" id="kpiSuspension">0%</div>
                    <div class="kpi-foot">De procedimientos</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stat-card">
                    <div class="kpi-label-with-info">
                        <span class="kpi-label">Especialidad principal</span>
                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Especialidad con el mayor consumo de kits, inferida automáticamente del tipo de kit utilizado. Este KPI destaca el foco principal de actividad quirúrgica, facilitando la asignación presupuestaria, capacitación especializada y gestión de inventarios específicos para áreas de alta demanda."></i>
                    </div>
                    <div class="kpi-value" id="kpiEspecialidad">-</div>
                    <div class="kpi-foot">Por consumo</div>
                </div>
            </div>
        </div>

        <!-- KPIs Secundarios -->
        <div class="row">
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="kpi-label-with-info">
                        <span class="kpi-label">Descargas filtradas</span>
                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Número total de registros de descargas de kits en el período y filtros aplicados. Representa la actividad total registrada, útil para validar la integridad de datos y comparar volúmenes entre diferentes segmentos o períodos."></i>
                    </div>
                    <div class="kpi-value" id="kpiDescargas">0</div>
                    <div class="kpi-foot">Filas registradas</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="kpi-label-with-info">
                        <span class="kpi-label">Promedio diario</span>
                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Promedio de descargas de kits por día en el rango filtrado. Este indicador proporciona insight sobre la carga operativa diaria promedio, ayudando a detectar variaciones estacionales o impactos de eventos específicos en la actividad."></i>
                    </div>
                    <div class="kpi-value" id="kpiPromedioDiario">0</div>
                    <div class="kpi-foot">Descargas / día</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="kpi-label-with-info">
                        <span class="kpi-label">Farmacias activas</span>
                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Número de farmacias o almacenes con registros de actividad en el período filtrado. Ayuda a evaluar la distribución geográfica o departamental de la actividad quirúrgica."></i>
                    </div>
                    <div class="kpi-value" id="kpiFarmaciasActivas">0</div>
                    <div class="kpi-foot">en rango filtrado</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="kpi-label-with-info">
                        <span class="kpi-label">Total de kits</span>
                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Cantidad total de unidades de kits consumidas en el período filtrado. Este KPI es esencial para el control de inventarios, pronóstico de compras y análisis de costos asociados al consumo de materiales quirúrgicos."></i>
                    </div>
                    <div class="kpi-value" id="kpiTotalKits">0</div>
                    <div class="kpi-foot">unidades consumidas</div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">Visión General</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="personnel-tab" data-bs-toggle="tab" data-bs-target="#personnel" type="button" role="tab">Personal</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="kits-tab" data-bs-toggle="tab" data-bs-target="#kits" type="button" role="tab">Kits</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="efficiency-tab" data-bs-toggle="tab" data-bs-target="#efficiency" type="button" role="tab">Eficiencia Operativa</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="stock-tab" data-bs-toggle="tab" data-bs-target="#stock" type="button" role="tab">Inteligencia de Stock</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="data-tab" data-bs-toggle="tab" data-bs-target="#data" type="button" role="tab">Datos</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="segmentation-tab" data-bs-toggle="tab" data-bs-target="#segmentation" type="button" role="tab">Segmentación</button>
            </li>
        </ul>

        <div class="tab-content" id="dashboardTabsContent">
            <!-- OVERVIEW -->
            <div class="tab-pane fade show active" id="overview" role="tabpanel">
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <div class="title-with-info">
                                    <h5>Descargas por día y farmacia</h5>
                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Gráfico de líneas que muestra la evolución diaria del número de descargas de kits por farmacia/almacén. Permite identificar picos de actividad, tendencias temporales y diferencias entre ubicaciones, facilitando el análisis de demanda y posibles anomalías en el flujo operativo. Usa zoom y pan para explorar detalles."></i>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="chartDiaFarmacia"></canvas>
                                </div>
                                <div class="chart-note">
                                    Métrica: número de registros (descargas de kits) por Fecha y Farmacia/Almacén. Las líneas representan diferentes farmacias para comparación visual.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Turnos y Tipos -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <div class="title-with-info">
                                    <h5>Registros por Turno</h5>
                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Distribución porcentual de registros por turno horario. Este gráfico ayuda a visualizar la carga de trabajo por período del día, identificando turnos sobrecargados para optimizar la asignación de personal y recursos."></i>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="turnoChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <div class="title-with-info">
                                    <h5>Distribución por Tipo</h5>
                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Distribución porcentual por tipo de personal involucrado (ej. anestesiólogo vs. circulante). Revela el balance de participación y puede indicar necesidades de entrenamiento o reasignación."></i>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="tipoChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PERSONNEL -->
            <div class="tab-pane fade" id="personnel" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <div class="title-with-info">
                                    <h5>Anestesiólogos Más Activos</h5>
                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Ranking de los 10 anestesiólogos con más registros de actividad. Este gráfico identifica al personal más involucrado, útil para reconocimiento, carga de trabajo y planificación de rotaciones."></i>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="topAnestesiologosChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <div class="title-with-info">
                                    <h5>Circulantes Más Activos</h5>
                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Ranking de los 10 circulantes con más registros. Ayuda en la gestión de equipo, detección de sobrecargas y evaluación de rendimiento individual."></i>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="topCirculantesChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Distribución por Quirófano -->
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <div class="title-with-info">
                                    <h5>Distribución de Personal por Quirófano</h5>
                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Número de anestesiólogos y circulantes asignados por quirófano. Este gráfico stacked bar muestra la distribución para evaluar equilibrio y posibles necesidades de reasignación."></i>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="personalQuirfanoChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- KITS -->
            <div class="tab-pane fade" id="kits" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <div class="title-with-info">
                                    <h5>Kits Más Utilizados</h5>
                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Top 10 kits por cantidad total consumida. Identifica items de alta demanda para priorizar en inventarios y negociaciones con proveedores."></i>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="topKitsChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <div class="title-with-info">
                                    <h5>Cantidad Total de Kits por Tipo</h5>
                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Distribución de la cantidad total de kits consumidos por tipo de personal. Ayuda a entender patrones de uso por rol."></i>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="kitsCantidadChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Distribución por Quirófano -->
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <div class="title-with-info">
                                    <h5>Distribución de Kits por Quirófano</h5>
                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Cantidad total de kits consumidos por cada quirófano, ordenado por volumen descendente. Revela quirófanos de alta actividad para enfocarse en mantenimiento y suministro."></i>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="kitsQuirfanoChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- EFICIENCIA OPERATIVA -->
            <div class="tab-pane fade" id="efficiency" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <div class="title-with-info">
                                    <h5>Rotación de Quirófanos</h5>
                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Promedio de procedimientos por día por cada quirófano. Este indicador mide la rotación y utilización, destacando quirófanos subutilizados o sobrecargados para optimizaciones."></i>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="rotacionQuirfanosChart"></canvas>
                                </div>
                                <div class="chart-note">
                                    Número de procedimientos por quirófano por día. Barras más altas indican mayor rotación.
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <div class="title-with-info">
                                    <h5>Eficiencia de Personal Médico</h5>
                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Top 15 profesionales por promedio de procedimientos por día trabajado. Este KPI evalúa productividad individual, ayudando en evaluaciones de rendimiento y detección de líderes o necesidades de soporte."></i>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="eficienciaPersonalChart"></canvas>
                                </div>
                                <div class="chart-note">
                                    Procedimientos por profesional (top 15). Considera solo días activos.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <div class="title-with-info">
                                    <h5>Análisis de Patrones de Consumo por Especialidad</h5>
                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Consumo total de kits por especialidad inferida del tipo de kit. Este análisis revela patrones de demanda por área médica, facilitando pronósticos y asignación de recursos específicos."></i>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="patronesConsumoChart"></canvas>
                                </div>
                                <div class="chart-note">
                                    Consumo de kits por tipo de especialidad inferida. 'Otra' incluye kits no clasificados.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- INTELIGENCIA DE STOCK -->
            <div class="tab-pane fade" id="stock" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <div class="title-with-info">
                                    <h5>Curva ABC de Kits</h5>
                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Clasificación de kits por valor acumulativo de consumo (A: 80% del valor, B: 15%, C: 5%). Este análisis sigue el principio de Pareto para priorizar la gestión de inventarios en items de alto impacto, optimizando costos y disponibilidad."></i>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="curvaABCChart"></canvas>
                                </div>
                                <div class="chart-note">
                                    Clasificación por valor de consumo (80/20). Colores: Rojo=A, Naranja=B, Verde=C.
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <div class="title-with-info">
                                    <h5>Previsión de Consumo</h5>
                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Tendencia mensual de consumo con proyección avanzada a 3 meses usando suavizado exponencial (alpha=0.3) para capturar tendencias recientes. Basado en los últimos 6 meses, este análisis predictivo ayuda en la planificación de compras, evitando stockouts o excesos, con consideración de variabilidad estacional."></i>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="previsionConsumoChart"></canvas>
                                </div>
                                <div class="chart-note">
                                    Tendencia y proyección mensual usando suavizado exponencial. Línea punteada indica pronóstico. Usa zoom para detalles.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <div class="title-with-info">
                                    <h5>Análisis de Estacionalidad</h5>
                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Consumo de kits por día de la semana y turno horario. Este gráfico stacked revela patrones estacionales y horarios, permitiendo optimizar programación, asignación de stock y personal para períodos de alta demanda."></i>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="estacionalidadChart"></canvas>
                                </div>
                                <div class="chart-note">
                                    Consumo por día de la semana y turno. Colores diferencian turnos para análisis comparativo.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- DATA -->
            <div class="tab-pane fade" id="data" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div class="title-with-info">
                            <h5>Registros recientes, filtrados</h5>
                            <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Tabla detallada con los 100 registros más recientes según filtros aplicados, ordenados por timestamp descendente. Incluye todas las variables clave para auditoría y análisis granular; soporta exportación a CSV para informes externos. La tabla es interactiva con búsqueda, ordenación y paginación."></i>
                        </div>
                        <button class="btn btn-sm btn-outline-light" id="exportData">
                            <i class="bi bi-download"></i> Exportar Datos
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table table-striped table-hover" id="dataTable">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Farmacia</th>
                                        <th>Turno</th>
                                        <th>Tipo</th>
                                        <th>Nombre</th>
                                        <th>Quirófano</th>
                                        <th>Kit</th>
                                        <th>Cantidad</th>
                                        <th>Usuario</th>
                                        <th>Timestamp</th>
                                    </tr>
                                </thead>
                                <tbody id="dataTableBody"></tbody>
                            </table>
                        </div>
                        <div class="footnote">
                            Muestra hasta 100 filas más recientes según filtros aplicados. Usa la búsqueda y ordenación para explorar.
                        </div>
                    </div>
                </div>
            </div>

            <!-- SEGMENTATION -->
            <div class="tab-pane fade" id="segmentation" role="tabpanel">
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <div class="title-with-info">
                                    <h5>Consumo por Especialidad y Turno</h5>
                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Gráfico stacked de consumo de kits por especialidad y turno. Permite segmentar datos para análisis detallado de patrones por área médica y horario."></i>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="segmentEspecialidadTurnoChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <div class="title-with-info">
                                    <h5>Procedimientos por Quirofano y Tipo</h5>
                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Distribución de procedimientos por quirófano y tipo de personal. Útil para segmentar y analizar utilización por instalación y rol."></i>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="segmentQuirofanoTipoChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <div class="title-with-info">
                                    <h5>Consumo por Farmacia y Especialidad</h5>
                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Gráfico stacked de consumo de kits por farmacia y especialidad. Permite segmentar datos para análisis de distribución por ubicación y área médica. Usa zoom para detalles."></i>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="segmentFarmaciaEspecialidadChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div> <!-- tab-content -->
    </div> <!-- container-fluid -->
</div> <!-- dashboardScreen -->

<footer>
    Ministerio de Trabajo, Empleo y Seguridad Social - Área de Apoyo Médico IPS<br>
    Control de stock por quirófano
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
// ======================================================================
// CONFIGURACIÓN
// ======================================================================

// Credenciales válidas
const AUTH_MAP = {
  "dbmeza":  "3704196",
  "clawes":  "524307",
  "memarti": "4187108",
  "dbazan":  "1943078"
};

// Google Sheet origen de datos
const SHEET_ID   = "13mzYK7HsvwiKyMXDpZJ3d1fLRvkwPYbOKUeedYSUh68";
const SHEET_NAME = "Registros";

// Estado inicial de sesión pre-logueada (en GitHub Pages siempre false)
const AUTH_OK_INIT  = false;
const SESSION_TOKEN = "";
const INITIAL_USER  = "";

// ======================================================================
// Estado global
// ======================================================================
let originalData   = [];
let filteredData   = [];
let charts         = {};
let currentUser    = null;
let currentToken   = null;

// ======================================================================
// Helpers de parseo CSV
// ======================================================================

// Parsea CSV en arrays de filas, cada fila = array de celdas.
// Soporta comillas dobles, comas dentro de comillas, saltos de línea estándar.
function parseCSV(raw) {
    const rows = [];
    let curRow = [];
    let curVal = "";
    let inQuotes = false;

    for (let i = 0; i < raw.length; i++) {
        const c = raw[i];
        const next = raw[i+1];

        if (inQuotes) {
            if (c === '"' && next === '"') {
                // comilla escapada ""
                curVal += '"';
                i++;
            } else if (c === '"') {
                // fin de bloque con comillas
                inQuotes = false;
            } else {
                curVal += c;
            }
        } else {
            if (c === '"') {
                inQuotes = true;
            } else if (c === ",") {
                curRow.push(curVal.trim());
                curVal = "";
            } else if (c === "\r") {
                // ignorar \r; se maneja en \n
            } else if (c === "\n") {
                curRow.push(curVal.trim());
                rows.push(curRow);
                curRow = [];
                curVal = "";
            } else {
                curVal += c;
            }
        }
    }
    // último valor si no terminó en \n
    if (curVal.length > 0 || inQuotes || curRow.length > 0) {
        curRow.push(curVal.trim());
        rows.push(curRow);
    }

    return rows;
}

// Convierte filas CSV (arrays) a objetos usando la primera fila como headers
function rowsToObjects(rows) {
    if (!rows || rows.length < 2) return [];

    const headersRaw = rows[0];
    // normalizamos headers quitando espacios duplicados
    const headers = headersRaw.map(h => (h || "").trim());

    const out = [];
    for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        if (row.every(c => c === "")) {
            continue; // fila vacía
        }
        const obj = {};
        for (let j = 0; j < headers.length; j++) {
            obj[headers[j]] = row[j] !== undefined ? row[j] : "";
        }
        out.push(obj);
    }
    return out;
}

// ======================================================================
// Utilidades de datos
// ======================================================================

function toISO(dateStr) {
  if (!dateStr) return null;

  // ya viene como yyyy-mm-dd
  const m = dateStr.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (m) return dateStr;

  // dd/mm/yyyy
  const m2 = dateStr.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if (m2) {
    const dd = m2[1].padStart(2,"0");
    const mm = m2[2].padStart(2,"0");
    const yyyy = m2[3];
    return `${yyyy}-${mm}-${dd}`;
  }

  // fallback
  const dObj = new Date(dateStr);
  if (!isNaN(dObj.getTime())) {
    const dd2 = String(dObj.getDate()).padStart(2,"0");
    const mm2 = String(dObj.getMonth()+1).padStart(2,"0");
    const yyyy2 = dObj.getFullYear();
    return `${yyyy2}-${mm2}-${dd2}`;
  }

  return null;
}

function normalizeQuirfano(q) {
  if (!q) return "";
  if (/^\d+$/.test(q)) return "Q" + q;
  if (/^Q\d+$/i.test(q)) return q;
  return q;
}

function toNumber(x) {
  if (x == null || x === "") return 0;
  const n = Number(String(x).replace(",", "."));
  return Number.isFinite(n) ? n : 0;
}

function parseTS(ts) {
  if (!ts) return null;
  // Timestamp suele venir "dd/mm/yyyy hh:mm:ss"
  // Separamos por espacio
  const parts = ts.split(" ");
  const baseISO = toISO(parts[0] || "");
  if (!baseISO) return null;
  const hhmmss = parts[1] ? parts[1] : "00:00:00";
  const d = new Date(baseISO + "T" + hhmmss);
  if (isNaN(d.getTime())) return null;
  return d;
}

// Función para agregar meses a una fecha YYYY-MM
function addMonthsToYYYYMM(yyyyMm, monthsToAdd) {
    const [year, month] = yyyyMm.split('-').map(Number);
    let newMonth = month + monthsToAdd;
    let newYear = year;
    while (newMonth > 12) {
        newMonth -= 12;
        newYear++;
    }
    return `${newYear}-${String(newMonth).padStart(2, '0')}`;
}

// ======================================================================
// UI helpers
// ======================================================================

function showLoading() {
  document.getElementById("loading").style.display = "flex";
}
function hideLoading() {
  document.getElementById("loading").style.display = "none";
}

function showLoginScreen() {
  document.getElementById("loginScreen").style.display = "flex";
  document.getElementById("dashboardScreen").style.display = "none";
}
function showDashboardScreen() {
  document.getElementById("loginScreen").style.display = "none";
  document.getElementById("dashboardScreen").style.display = "block";
}

function showLoginError(msg) {
  const e = document.getElementById("loginError");
  e.textContent = msg;
  e.style.display = "block";
}

// ======================================================================
// KPIs y cálculos estadísticos
// ======================================================================

function calcKPIs(data) {
  const total = data.length;
  const unidades = data.reduce((acc, r) => acc + (r.Cantidad_num || 0), 0);
  const farmSet = new Set(data.map(r => r.Farmacia));
  const nFarm   = farmSet.size;

  const diasSet = new Set(
    data.map(r => r.Fecha_iso).filter(d => !!d)
  );
  const nDias   = diasSet.size || 1;
  const prom    = total / nDias;

  return { total, unidades, nFarm, prom };
}

function inferEspecialidad(kit) {
    if (!kit) return "Otra";
    const kitUpper = kit.toUpperCase();
    const mapeo = {
        "OFTALMOLOGIA": "Oftalmología",
        "UROLOGIA": "Urología",
        "COLONOSCOPIA": "Gastroenterología",
        "TRAUMATOLOGIA": "Traumatología",
        "NEURO": "Neurocirugía",
        "MALE": "Anestesiología",
        "KIQ": "Cirugía General",
        "BLOQUE": "Bloques Quirúrgicos",
        "MALETÍN": "Equipos Móviles",
        "MALETIN": "Equipos Móviles"
    };
    for (const key in mapeo) {
        if (kitUpper.includes(key)) {
            return mapeo[key];
        }
    }
    return "Otra";
}

function inferirEspecialidades(data) {
    const especialidades = {};
    data.forEach(r => {
        const esp = inferEspecialidad(r.Nombre_kit);
        especialidades[esp] = (especialidades[esp] || 0) + (r.Cantidad_num || 0);
    });
    return especialidades;
}

function calcKPIsEspecializados(data) {
    const total = data.length;
    const unidades = data.reduce((acc, r) => acc + (r.Cantidad_num || 0), 0);
    const farmSet = new Set(data.map(r => r.Farmacia));
    const nFarm = farmSet.size;
    
    const diasSet = new Set(data.map(r => r.Fecha_iso).filter(d => !!d));
    const nDias = diasSet.size || 1;
    const prom = total / nDias;
    
    const turnoCount = {};
    data.forEach(r => {
        if (r.Turno) {
            turnoCount[r.Turno] = (turnoCount[r.Turno] || 0) + 1;
        }
    });
    const turnoMasActivo = Object.keys(turnoCount).length > 0 ?
        Object.keys(turnoCount).reduce((a, b) =>
            turnoCount[a] > turnoCount[b] ? a : b
        )
        : "-";
    
    const suspensiones = data.filter(r =>
        r.Observaciones && r.Observaciones.toLowerCase().includes("suspend")
    ).length;
    const tasaSuspension = total > 0 ? (suspensiones / total * 100).toFixed(1) : "0.0";
    
    const kitsPorProc = total > 0 ? (unidades / total).toFixed(1) : "0.0";
    
    const especialidades = inferirEspecialidades(data);
    const especialidadPrincipal = Object.keys(especialidades).length > 0 ?
        Object.keys(especialidades).reduce((a, b) =>
            especialidades[a] > especialidades[b] ? a : b
        )
        : "-";
    
    const quirfanosUnicos = [...new Set(data.map(r => r.Quirofano).filter(q => q))];
    const eficiencia = quirfanosUnicos.length > 0 ?
        (total / (quirfanosUnicos.length * nDias)).toFixed(1)
        : "0.0";

    return { 
        total, 
        unidades, 
        nFarm, 
        prom, 
        turnoMasActivo, 
        tasaSuspension,
        kitsPorProc,
        especialidadPrincipal,
        eficiencia
    };
}

function renderKPIs(k) {
  document.getElementById("kpiDescargas").textContent        = k.total.toLocaleString("es-PY");
  document.getElementById("kpiPromedioDiario").textContent    = k.prom.toFixed(2);
  document.getElementById("kpiFarmaciasActivas").textContent  = k.nFarm.toLocaleString("es-PY");
  document.getElementById("kpiTotalKits").textContent         = k.unidades.toLocaleString("es-PY");
}

function renderKPIsEspecializados(k) {
    document.getElementById("kpiProcedimientos").textContent = k.total.toLocaleString("es-PY");
    document.getElementById("kpiEficiencia").textContent = k.eficiencia + "%";
    document.getElementById("kpiKitsPorProc").textContent = k.kitsPorProc;
    document.getElementById("kpiTurnoActivo").textContent = k.turnoMasActivo;
    document.getElementById("kpiSuspension").textContent = k.tasaSuspension + "%";
    document.getElementById("kpiEspecialidad").textContent = k.especialidadPrincipal;
    
    const eficienciaElem = document.getElementById("kpiEficiencia");
    const tasaEfic = parseFloat(k.eficiencia);
    if (tasaEfic > 80) {
        eficienciaElem.classList.add("kpi-success");
        eficienciaElem.classList.remove("kpi-warning");
    } else if (tasaEfic < 60) {
        eficienciaElem.classList.add("kpi-warning");
        eficienciaElem.classList.remove("kpi-success");
    } else {
        eficienciaElem.classList.remove("kpi-success", "kpi-warning");
    }
    
    const suspensionElem = document.getElementById("kpiSuspension");
    const tasaSusp = parseFloat(k.tasaSuspension);
    if (tasaSusp > 10) {
        suspensionElem.classList.add("kpi-warning");
    } else {
        suspensionElem.classList.remove("kpi-warning");
    }
}

// ======================================================================
// Gráficos
// ======================================================================

function destroyCharts() {
  Object.values(charts).forEach(ch => { if (ch && ch.destroy) ch.destroy(); });
  charts = {};
}

function getCommonOptions() {
    return {
        plugins: {
            zoom: {
                zoom: {
                    wheel: {
                        enabled: true,
                    },
                    pinch: {
                        enabled: true
                    },
                    mode: 'xy',
                },
                pan: {
                    enabled: true,
                    mode: 'xy',
                }
            }
        }
    };
}

function createChartDiaFarmacia() {
  const ctx = document.getElementById("chartDiaFarmacia").getContext("2d");
  const M = {};
  filteredData.forEach(r => {
    if (!r.Fecha_iso || !r.Farmacia) return;
    if (!M[r.Fecha_iso]) M[r.Fecha_iso] = {};
    if (!M[r.Fecha_iso][r.Farmacia]) M[r.Fecha_iso][r.Farmacia] = 0;
    M[r.Fecha_iso][r.Farmacia] += 1;
  });

  const fechas = Object.keys(M).sort();
  const farmCodes = [...new Set(
    fechas.flatMap(F => Object.keys(M[F]))
  )].sort();

  const labels = fechas.map(F => {
    const [y,m,d] = F.split("-");
    return d + "/" + m + "/" + y;
  });

  const datasets = farmCodes.map(code => {
    const serie = fechas.map(F => M[F][code] || 0);
    return {
      label: code,
      data: serie,
      borderWidth: 2,
      tension: 0.2,
      fill: false
    };
  });

  const options = {
    type: "line",
    data: { labels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: "index", intersect: false },
      plugins: {
        legend: { position: "bottom" },
        tooltip: {
          callbacks: {
            label: function(c) { return c.dataset.label + ": " + c.parsed.y + " descargas"; }
          }
        },
        datalabels: {
          display: false
        }
      },
      scales: {
        x: { title: { display: true, text: "Fecha" } },
        y: { beginAtZero: true, title: { display: true, text: "Descargas" } }
      },
      ...getCommonOptions()
    }
  };

  charts.chartDiaFarmacia = new Chart(ctx, options);
}

function createTurnoChart() {
  const ctx = document.getElementById("turnoChart").getContext("2d");
  const turnoData = {};
  filteredData.forEach(r => {
    if (r.Turno) {
      turnoData[r.Turno] = (turnoData[r.Turno] || 0) + 1;
    }
  });

  charts.turnoChart = new Chart(ctx, {
    type: "doughnut",
    data: {
      labels: Object.keys(turnoData),
      datasets: [{
        data: Object.values(turnoData),
        backgroundColor: [
          "rgba(255, 99, 132, 0.7)",
          "rgba(54, 162, 235, 0.7)",
          "rgba(255, 206, 86, 0.7)",
          "rgba(75, 192, 192, 0.7)",
          "rgba(153, 102, 255, 0.7)"
        ]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        datalabels: {
          color: '#fff',
          font: { weight: 'bold' },
          formatter: (value, ctx) => {
            let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
            let percentage = Math.round((value / sum) * 100) + '%';
            return percentage;
          }
        }
      },
      ...getCommonOptions()
    },
    plugins: [ChartDataLabels]
  });
}

function createTipoChart() {
  const ctx = document.getElementById("tipoChart").getContext("2d");
  const tipoData = {};
  filteredData.forEach(r => {
    if (r.Tipo) {
      tipoData[r.Tipo] = (tipoData[r.Tipo] || 0) + 1;
    }
  });

  charts.tipoChart = new Chart(ctx, {
    type: "pie",
    data: {
      labels: Object.keys(tipoData),
      datasets: [{
        data: Object.values(tipoData),
        backgroundColor: [
          "rgba(153, 102, 255, 0.7)",
          "rgba(255, 159, 64, 0.7)"
        ]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        datalabels: {
          color: '#fff',
          font: { weight: 'bold' },
          formatter: (value, ctx) => {
            let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
            let percentage = Math.round((value / sum) * 100) + '%';
            return percentage;
          }
        }
      },
      ...getCommonOptions()
    },
    plugins: [ChartDataLabels]
  });
}

function createTopAnestesiologosChart() {
  const ctx = document.getElementById("topAnestesiologosChart").getContext("2d");

  const anestData = {};
  filteredData
    .filter(r => r.Tipo === "Anestesiólogo")
    .forEach(r => {
      if (r.Nombre) {
        anestData[r.Nombre] = (anestData[r.Nombre] || 0) + 1;
      }
    });

  const top = Object.entries(anestData)
    .sort(function(a,b){ return b[1] - a[1]; })
    .slice(0,10);

  charts.topAnestesiologosChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: top.map(function(x){ return x[0]; }),
      datasets: [{
        label: "Registros",
        data: top.map(function(x){ return x[1]; }),
        backgroundColor: "rgba(54, 162, 235, 0.7)",
        borderColor:   "rgba(54, 162, 235, 1)",
        borderWidth: 1
      }]
    },
    options: {
      indexAxis: "y",
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { beginAtZero: true }
      },
      plugins: {
        datalabels: {
          anchor: 'end',
          align: 'end',
          color: var(--text-main),
          font: { weight: 'bold' }
        }
      },
      ...getCommonOptions()
    },
    plugins: [ChartDataLabels]
  });
}

function createTopCirculantesChart() {
  const ctx = document.getElementById("topCirculantesChart").getContext("2d");

  const circData = {};
  filteredData
    .filter(r => r.Tipo === "Circulante")
    .forEach(r => {
      if (r.Nombre) {
        circData[r.Nombre] = (circData[r.Nombre] || 0) + 1;
      }
    });

  const top = Object.entries(circData)
    .sort(function(a,b){ return b[1] - a[1]; })
    .slice(0,10);

  charts.topCirculantesChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: top.map(function(x){ return x[0]; }),
      datasets: [{
        label: "Registros",
        data: top.map(function(x){ return x[1]; }),
        backgroundColor: "rgba(75, 192, 192, 0.7)",
        borderColor:   "rgba(75, 192, 192, 1)",
        borderWidth: 1
      }]
    },
    options: {
      indexAxis: "y",
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { beginAtZero: true }
      },
      plugins: {
        datalabels: {
          anchor: 'end',
          align: 'end',
          color: var(--text-main),
          font: { weight: 'bold' }
        }
      },
      ...getCommonOptions()
    },
    plugins: [ChartDataLabels]
  });
}

function createPersonalQuirfanoChart() {
  const ctx = document.getElementById("personalQuirfanoChart").getContext("2d");
  const M = {};
  filteredData.forEach(r => {
    const q  = r.Quirofano || "Sin asignar";
    const tp = r.Tipo || "Sin tipo";
    if (!M[q]) {
      M[q] = { "Anestesiólogo":0, "Circulante":0 };
    }
    if (tp in M[q]) {
      M[q][tp] += 1;
    }
  });

  const quirfanos = Object.keys(M).sort();
  const anestArr  = quirfanos.map(function(q){ return M[q]["Anestesiólogo"]; });
  const circArr   = quirfanos.map(function(q){ return M[q]["Circulante"]; });

  charts.personalQuirfanoChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: quirfanos,
      datasets: [
        {
          label: "Anestesiólogos",
          data: anestArr,
          backgroundColor: "rgba(153, 102, 255, 0.7)",
          borderColor:     "rgba(153, 102, 255, 1)",
          borderWidth: 1
        },
        {
          label: "Circulantes",
          data: circArr,
          backgroundColor: "rgba(255, 159, 64, 0.7)",
          borderColor:     "rgba(255, 159, 64, 1)",
          borderWidth: 1
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: { beginAtZero: true, stacked: true },
        x: { stacked: true }
      },
      plugins: {
        datalabels: {
          display: false
        }
      },
      ...getCommonOptions()
    }
  });
}

function createTopKitsChart() {
  const ctx = document.getElementById("topKitsChart").getContext("2d");
  const kitsData = {};
  filteredData.forEach(r => {
    const kit = r.Nombre_kit;
    if (kit && kit !== "*") {
      kitsData[kit] = (kitsData[kit] || 0) + (r.Cantidad_num || 0);
    }
  });

  const top = Object.entries(kitsData)
    .sort(function(a,b){ return b[1]-a[1]; })
    .slice(0,10);

  charts.topKitsChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: top.map(function(x){ return x[0]; }),
      datasets: [{
        label: "Cantidad",
        data: top.map(function(x){ return x[1]; }),
        backgroundColor: "rgba(255, 99, 132, 0.7)",
        borderColor:   "rgba(255, 99, 132, 1)",
        borderWidth: 1
      }]
    },
    options: {
      indexAxis:"y",
      responsive:true,
      maintainAspectRatio:false,
      scales: {
        x: { beginAtZero:true }
      },
      plugins: {
        datalabels: {
          anchor: 'end',
          align: 'end',
          color: var(--text-main),
          font: { weight: 'bold' }
        }
      },
      ...getCommonOptions()
    },
    plugins: [ChartDataLabels]
  });
}

function createKitsCantidadChart() {
  const ctx = document.getElementById("kitsCantidadChart").getContext("2d");
  const sumTipo = {};
  filteredData.forEach(r => {
    const tp = r.Tipo || "Sin tipo";
    sumTipo[tp] = (sumTipo[tp] || 0) + (r.Cantidad_num || 0);
  });

  charts.kitsCantidadChart = new Chart(ctx, {
    type:"doughnut",
    data:{
      labels:Object.keys(sumTipo),
      datasets:[{
        data:Object.values(sumTipo),
        backgroundColor:[
          "rgba(153, 102, 255, 0.7)",
          "rgba(255, 159, 64, 0.7)"
        ]
      }]}
    ,
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins: {
        datalabels: {
          color: '#fff',
          font: { weight: 'bold' },
          formatter: (value, ctx) => {
            let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
            let percentage = Math.round((value / sum) * 100) + '%';
            return percentage;
          }
        }
      },
      ...getCommonOptions()
    },
    plugins: [ChartDataLabels]
  });
}

function createKitsQuirfanoChart() {
  const ctx = document.getElementById("kitsQuirfanoChart").getContext("2d");
  const sumQ = {};
  filteredData.forEach(r => {
    const q = r.Quirofano || "Sin asignar";
    sumQ[q] = (sumQ[q] || 0) + (r.Cantidad_num || 0);
  });

  const sortedQ = Object.entries(sumQ).sort(function(a,b){ return b[1]-a[1]; });
  charts.kitsQuirfanoChart = new Chart(ctx, {
    type:"bar",
    data:{
      labels:sortedQ.map(function(x){ return x[0]; }),
      datasets:[{
        label:"Cantidad de Kits",
        data:sortedQ.map(function(x){ return x[1]; }),
        backgroundColor:"rgba(75, 192, 192, 0.7)",
        borderColor:"rgba(75, 192, 192, 1)",
        borderWidth:1
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      scales:{
        y:{ beginAtZero:true }
      },
      plugins: {
        datalabels: {
          anchor: 'end',
          align: 'end',
          color: var(--text-main),
          font: { weight: 'bold' }
        }
      },
      ...getCommonOptions()
    },
    plugins: [ChartDataLabels]
  });
}

// Eficiencia operativa
function createRotacionQuirfanosChart() {
    const ctx = document.getElementById("rotacionQuirfanosChart").getContext("2d");
    const rotacion = {};
    filteredData.forEach(r => {
        if (r.Quirofano && r.Fecha_iso) {
            const key = r.Quirofano;
            if (!rotacion[key]) rotacion[key] = { total: 0, dias: new Set() };
            rotacion[key].total += 1;
            rotacion[key].dias.add(r.Fecha_iso);
        }
    });

    const labels = Object.keys(rotacion).sort();
    const dataVals = labels.map(q => {
        const dias = rotacion[q].dias.size;
        return dias > 0 ? (rotacion[q].total / dias).toFixed(1) : 0;
    });

    charts.rotacionQuirfanosChart = new Chart(ctx, {
        type: "bar",
        data: {
            labels: labels,
            datasets: [{
                label: "Procedimientos/día",
                data: dataVals,
                backgroundColor: "rgba(54, 162, 235, 0.7)",
                borderColor: "rgba(54, 162, 235, 1)",
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: "Procedimientos por día" }
                },
                x: {
                    title: { display: true, text: "Quirófano" }
                }
            },
            plugins: {
                datalabels: {
                    anchor: 'end',
                    align: 'end',
                    color: var(--text-main),
                    font: { weight: 'bold' }
                }
            },
            ...getCommonOptions()
        },
        plugins: [ChartDataLabels]
    });
}

function createEficienciaPersonalChart() {
    const ctx = document.getElementById("eficienciaPersonalChart").getContext("2d");
    const eficiencia = {};
    filteredData.forEach(r => {
        if (r.Nombre && r.Fecha_iso) {
            if (!eficiencia[r.Nombre]) eficiencia[r.Nombre] = { total: 0, dias: new Set() };
            eficiencia[r.Nombre].total += 1;
            eficiencia[r.Nombre].dias.add(r.Fecha_iso);
        }
    });

    const eficienciaArray = Object.entries(eficiencia).map(function(pair) {
        const nombre = pair[0];
        const datos = pair[1];
        const dias = datos.dias.size;
        return {
            nombre: nombre,
            eficiencia: dias > 0 ? (datos.total / dias).toFixed(1) : 0,
            total: datos.total
        };
    });

    const topEficiencia = eficienciaArray
        .sort(function(a,b){ return b.eficiencia - a.eficiencia; })
        .slice(0, 15);

    charts.eficienciaPersonalChart = new Chart(ctx, {
        type: "bar",
        data: {
            labels: topEficiencia.map(function(d){ return d.nombre; }),
            datasets: [{
                label: "Procedimientos/día",
                data: topEficiencia.map(function(d){ return d.eficiencia; }),
                backgroundColor: "rgba(75, 192, 192, 0.7)",
                borderColor: "rgba(75, 192, 192, 1)",
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: "y",
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    beginAtZero: true,
                    title: { display: true, text: "Procedimientos por día trabajado" }
                }
            },
            plugins: {
                datalabels: {
                    anchor: 'end',
                    align: 'end',
                    color: var(--text-main),
                    font: { weight: 'bold' }
                }
            },
            ...getCommonOptions()
        },
        plugins: [ChartDataLabels]
    });
}

// Patrones de consumo
function createPatronesConsumoChart() {
    const ctx = document.getElementById("patronesConsumoChart").getContext("2d");
    const especialidades = inferirEspecialidades(filteredData);

    const labels = Object.keys(especialidades);
    const dataVals = Object.values(especialidades);

    charts.patronesConsumoChart = new Chart(ctx, {
        type: "bar",
        data: {
            labels: labels,
            datasets: [{
                label: "Consumo por especialidad",
                data: dataVals,
                backgroundColor: "rgba(153, 102, 255, 0.7)",
                borderColor: "rgba(153, 102, 255, 1)",
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: "Unidades consumidas" }
                }
            },
            plugins: {
                datalabels: {
                    anchor: 'end',
                    align: 'end',
                    color: var(--text-main),
                    font: { weight: 'bold' }
                }
            },
            ...getCommonOptions()
        },
        plugins: [ChartDataLabels]
    });
}

// Stock
function createCurvaABCChart() {
    const ctx = document.getElementById("curvaABCChart").getContext("2d");
    const consumoKits = {};
    filteredData.forEach(r => {
        if (r.Nombre_kit && r.Nombre_kit !== "") {
            const kit = r.Nombre_kit;
            consumoKits[kit] = (consumoKits[kit] || 0) + (r.Cantidad_num || 0);
        }
    });

    const sorted = Object.entries(consumoKits)
        .sort(function(a, b){ return b[1] - a[1]; });

    const total = sorted.reduce(function(sum, item){ return sum + item[1]; }, 0);
    let acumulado = 0;
    const dataABC = sorted.map(function(item) {
        acumulado += item[1];
        const ratioAcum = total ? (acumulado / total) : 0;
        return {
            kit: item[0],
            consumo: item[1],
            categoria: ratioAcum <= 0.8 ? "A" :
                       ratioAcum <= 0.95 ? "B" : "C"
        };
    });

    const labels = dataABC.map(function(d){
        return d.kit.length > 20 ? d.kit.substring(0,20) + "..." : d.kit;
    });
    const dataVals = dataABC.map(function(d){ return d.consumo; });
    const backgroundColors = dataABC.map(function(d){
        if (d.categoria === "A") return "rgba(255, 99, 132, 0.7)";
        if (d.categoria === "B") return "rgba(255, 159, 64, 0.7)";
        return "rgba(75, 192, 192, 0.7)";
    });
    const borderColors = backgroundColors.map(function(c){
        return c.replace("0.7","1");
    });

    charts.curvaABCChart = new Chart(ctx, {
        type: "bar",
        data: {
            labels: labels,
            datasets: [{
                label: "Consumo",
                data: dataVals,
                backgroundColor: backgroundColors,
                borderColor: borderColors,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: "Unidades consumidas" }
                }
            },
            plugins: {
                datalabels: {
                    anchor: 'end',
                    align: 'end',
                    color: var(--text-main),
                    font: { weight: 'bold' }
                }
            },
            ...getCommonOptions()
        },
        plugins: [ChartDataLabels]
    });
}

function createPrevisionConsumoChart() {
    const ctx = document.getElementById("previsionConsumoChart").getContext("2d");

    const consumoMensual = {};
    filteredData.forEach(r => {
        if (r.Fecha_iso) {
            const mes = r.Fecha_iso.substring(0, 7);
            consumoMensual[mes] = (consumoMensual[mes] || 0) + (r.Cantidad_num || 0);
        }
    });

    const meses = Object.keys(consumoMensual).sort();
    const consumos = meses.map(function(mes){ return consumoMensual[mes]; });

    const ultimosMeses = meses.slice(-6);
    const ultimosConsumos = consumos.slice(-6);

    // Suavizado exponencial avanzado (alpha = 0.3)
    const alpha = 0.3;
    let smoothed = [ultimosConsumos[0] || 0];
    for (let i = 1; i < ultimosConsumos.length; i++) {
        smoothed[i] = alpha * ultimosConsumos[i] + (1 - alpha) * smoothed[i-1];
    }

    // Proyección con suavizado
    let lastSmoothed = smoothed[smoothed.length - 1];
    const consumosProyeccion = [];
    for (let i = 0; i < 3; i++) {
        lastSmoothed = alpha * lastSmoothed + (1 - alpha) * lastSmoothed; // Proyección constante con suavizado
        consumosProyeccion.push(Math.max(0, Math.round(lastSmoothed)));
    }

    const mesesProyeccion = [];
    let lastMes = ultimosMeses[ultimosMeses.length - 1] || '2025-10'; // Usando fecha actual aproximada
    for (let i = 1; i <= 3; i++) {
        lastMes = addMonthsToYYYYMM(lastMes, 1);
        mesesProyeccion.push(lastMes);
    }

    charts.previsionConsumoChart = new Chart(ctx, {
        type: "line",
        data: {
            labels: ultimosMeses.concat(mesesProyeccion),
            datasets: [
                {
                    label: "Consumo Real",
                    data: ultimosConsumos.concat(Array(3).fill(null)),
                    borderColor: "rgba(54, 162, 235, 1)",
                    backgroundColor: "rgba(54, 162, 235, 0.1)",
                    borderWidth: 2,
                    tension: 0.3,
                    fill: true
                },
                {
                    label: "Consumo Suavizado",
                    data: smoothed.concat(Array(3).fill(null)),
                    borderColor: "rgba(75, 192, 192, 1)",
                    backgroundColor: "rgba(75, 192, 192, 0.1)",
                    borderWidth: 2,
                    tension: 0.3,
                    fill: true
                },
                {
                    label: "Proyección",
                    data: Array(ultimosConsumos.length).fill(null).concat(consumosProyeccion),
                    borderColor: "rgba(255, 99, 132, 1)",
                    backgroundColor: "rgba(255, 99, 132, 0.1)",
                    borderWidth: 2,
                    borderDash: [5, 5],
                    tension: 0.3,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: "Unidades consumidas" }
                }
            },
            plugins: {
                datalabels: {
                    display: false
                }
            },
            ...getCommonOptions()
        }
    });
}

function createEstacionalidadChart() {
    const ctx = document.getElementById("estacionalidadChart").getContext("2d");
    const diasSemana = ["Domingo","Lunes","Martes","Miércoles","Jueves","Viernes","Sábado"];
    const estacionalidad = {};

    filteredData.forEach(r => {
        if (r.Fecha_iso && r.Turno) {
            const fechaObj = new Date(r.Fecha_iso + "T00:00:00");
            if (!isNaN(fechaObj.getTime())) {
                const diaSemana = diasSemana[fechaObj.getDay()];
                const turno = r.Turno;
                const key = diaSemana + " - " + turno;
                estacionalidad[key] = (estacionalidad[key] || 0) + (r.Cantidad_num || 0);
            }
        }
    });

    const diasOrdenados = ["Lunes","Martes","Miércoles","Jueves","Viernes","Sábado","Domingo"];
    const turnosUnicos = [];
    Object.keys(estacionalidad).forEach(function(k){
        const turno = k.split(" - ")[1];
        if (!turnosUnicos.includes(turno)) {
            turnosUnicos.push(turno);
        }
    });

    const datasets = turnosUnicos.map(function(turno){
        const dataVals = diasOrdenados.map(function(dia){
            const key = dia + " - " + turno;
            return estacionalidad[key] || 0;
        });
        let bg;
        if (turno.indexOf("Mañana") !== -1) {
            bg = "rgba(255, 206, 86, 0.7)";
        } else if (turno.indexOf("Tarde") !== -1) {
            bg = "rgba(54, 162, 235, 0.7)";
        } else if (turno.indexOf("Noche") !== -1) {
            bg = "rgba(153, 102, 255, 0.7)";
        } else {
            bg = "rgba(201, 203, 207, 0.7)";
        }
        return {
            label: turno,
            data: dataVals,
            backgroundColor: bg,
            stack: 'stack'
        };
    });

    charts.estacionalidadChart = new Chart(ctx, {
        type: "bar",
        data: {
            labels: diasOrdenados,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    stacked: true,
                    title: { display: true, text: "Unidades consumidas" }
                },
                x: {
                    stacked: true,
                    title: { display: true, text: "Día de la semana" }
                }
            },
            plugins: {
                datalabels: {
                    display: false
                }
            },
            ...getCommonOptions()
        }
    });
}

// Nuevos gráficos para segmentación
function createSegmentEspecialidadTurnoChart() {
    const ctx = document.getElementById("segmentEspecialidadTurnoChart").getContext("2d");
    const M = {};
    filteredData.forEach(r => {
        const esp = inferEspecialidad(r.Nombre_kit);
        const turno = r.Turno || "Sin turno";
        if (!M[esp]) M[esp] = {};
        M[esp][turno] = (M[esp][turno] || 0) + (r.Cantidad_num || 0);
    });

    const esps = Object.keys(M).sort();
    const turnos = [...new Set(esps.flatMap(e => Object.keys(M[e])))].sort();

    const datasets = turnos.map(t => {
        return {
            label: t,
            data: esps.map(e => M[e][t] || 0),
            backgroundColor: t.includes("Mañana") ? "rgba(255, 206, 86, 0.7)" :
                             t.includes("Tarde") ? "rgba(54, 162, 235, 0.7)" :
                             t.includes("Noche") ? "rgba(153, 102, 255, 0.7)" : "rgba(201, 203, 207, 0.7)",
            stack: 'stack'
        };
    });

    charts.segmentEspecialidadTurnoChart = new Chart(ctx, {
        type: "bar",
        data: {
            labels: esps,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { stacked: true, beginAtZero: true },
                x: { stacked: true }
            },
            ...getCommonOptions()
        }
    });
}

function createSegmentQuirofanoTipoChart() {
    const ctx = document.getElementById("segmentQuirofanoTipoChart").getContext("2d");
    const M = {};
    filteredData.forEach(r => {
        const q = r.Quirofano || "Sin asignar";
        const tp = r.Tipo || "Sin tipo";
        if (!M[q]) M[q] = {};
        M[q][tp] = (M[q][tp] || 0) + 1;
    });

    const qs = Object.keys(M).sort();
    const tipos = [...new Set(qs.flatMap(q => Object.keys(M[q])))].sort();

    const datasets = tipos.map(tp => {
        return {
            label: tp,
            data: qs.map(q => M[q][tp] || 0),
            backgroundColor: tp === "Anestesiólogo" ? "rgba(153, 102, 255, 0.7)" : "rgba(255, 159, 64, 0.7)",
            stack: 'stack'
        };
    });

    charts.segmentQuirofanoTipoChart = new Chart(ctx, {
        type: "bar",
        data: {
            labels: qs,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { stacked: true, beginAtZero: true },
                x: { stacked: true }
            },
            ...getCommonOptions()
        }
    });
}

function createSegmentFarmaciaEspecialidadChart() {
    const ctx = document.getElementById("segmentFarmaciaEspecialidadChart").getContext("2d");
    const M = {};
    filteredData.forEach(r => {
        const farm = r.Farmacia || "Sin farmacia";
        const esp = inferEspecialidad(r.Nombre_kit);
        if (!M[farm]) M[farm] = {};
        M[farm][esp] = (M[farm][esp] || 0) + (r.Cantidad_num || 0);
    });

    const farms = Object.keys(M).sort();
    const esps = [...new Set(farms.flatMap(f => Object.keys(M[f])))].sort();

    const colors = [
        "rgba(255, 99, 132, 0.7)",
        "rgba(54, 162, 235, 0.7)",
        "rgba(255, 206, 86, 0.7)",
        "rgba(75, 192, 192, 0.7)",
        "rgba(153, 102, 255, 0.7)",
        "rgba(255, 159, 64, 0.7)",
        "rgba(201, 203, 207, 0.7)"
    ];

    const datasets = esps.map((e, idx) => {
        return {
            label: e,
            data: farms.map(f => M[f][e] || 0),
            backgroundColor: colors[idx % colors.length],
            stack: 'stack'
        };
    });

    charts.segmentFarmaciaEspecialidadChart = new Chart(ctx, {
        type: "bar",
        data: {
            labels: farms,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { stacked: true, beginAtZero: true, title: { display: true, text: "Unidades consumidas" } },
                x: { stacked: true, title: { display: true, text: "Farmacia" } }
            },
            ...getCommonOptions()
        }
    });
}

// ======================================================================
// Tabla
// ======================================================================

function updateDataTable() {
  const tb = document.getElementById("dataTableBody");
  tb.innerHTML = "";

  const sorted = filteredData.slice().sort(function(a,b){
    return (b.Timestamp_obj||0) - (a.Timestamp_obj||0);
  });

  const top100 = sorted.slice(0,100);
  top100.forEach(r => {
    const tr = document.createElement("tr");
    const cols = [
      r.Fecha,
      r.Farmacia,
      r.Turno,
      r.Tipo,
      r.Nombre,
      r.Quirofano,
      r.Nombre_kit,
      r.Cantidad,
      r.Usuario,
      r.Timestamp
    ];
    cols.forEach(function(val, idx){
      const td = document.createElement("td");
      td.textContent = val || "";
      if (idx === 7) {
        td.style.textAlign = "right";
      }
      tr.appendChild(td);
    });
    tb.appendChild(tr);
  });

  if ($.fn.DataTable.isDataTable('#dataTable')) {
    $('#dataTable').DataTable().destroy();
  }
  $('#dataTable').DataTable({
    paging: true,
    searching: true,
    ordering: true,
    info: true,
    lengthChange: false,
    pageLength: 10,
    language: {
      search: "Buscar:",
      paginate: {
        first: "Primero",
        last: "Último",
        next: "Siguiente",
        previous: "Anterior"
      },
      info: "Mostrando _START_ a _END_ de _TOTAL_ entradas"
    }
  });
}

// ======================================================================
// Filtros
// ======================================================================

function populateFilters() {
  populateSelect("filtroFarmacia", r => r.Farmacia);
  populateSelect("filtroTurno", r => r.Turno);
  populateSelect("filtroTipo", r => r.Tipo);
  populateSelect("filtroQuirofano", r => r.Quirofano);
  populateSelect("filtroKit", r => r.Nombre_kit);
  populateSelect("filtroNombre", r => r.Nombre);
  populateSelect("filtroUsuario", r => r.Usuario);

  // Para especialidad
  const selEsp = document.getElementById("filtroEspecialidad");
  while (selEsp.options.length > 1) {
    selEsp.remove(1);
  }
  const esps = new Set(originalData.map(r => inferEspecialidad(r.Nombre_kit)));
  Array.from(esps).sort().forEach(e => {
    const opt = document.createElement("option");
    opt.value = e;
    opt.textContent = e;
    selEsp.appendChild(opt);
  });
}

function populateSelect(id, extractor) {
  const sel = document.getElementById(id);
  while (sel.options.length > 1) {
    sel.remove(1);
  }
  const values = new Set(originalData.map(extractor).filter(v => v));
  Array.from(values).sort().forEach(v => {
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v;
    sel.appendChild(opt);
  });
}

function applyFilters() {
  const fd = document.getElementById("filtroDesde").value || null;
  const fh = document.getElementById("filtroHasta").value || null;
  const ff = document.getElementById("filtroFarmacia").value || "__ALL__";
  const ft = document.getElementById("filtroTurno").value || "__ALL__";
  const fti = document.getElementById("filtroTipo").value || "__ALL__";
  const fq = document.getElementById("filtroQuirofano").value || "__ALL__";
  const fk = document.getElementById("filtroKit").value || "__ALL__";
  const fe = document.getElementById("filtroEspecialidad").value || "__ALL__";
  const fn = document.getElementById("filtroNombre").value || "__ALL__";
  const fu = document.getElementById("filtroUsuario").value || "__ALL__";

  filteredData = originalData.filter(function(r){
    if (ff !== "__ALL__" && r.Farmacia !== ff) return false;
    if (ft !== "__ALL__" && r.Turno !== ft) return false;
    if (fti !== "__ALL__" && r.Tipo !== fti) return false;
    if (fq !== "__ALL__" && r.Quirofano !== fq) return false;
    if (fk !== "__ALL__" && r.Nombre_kit !== fk) return false;
    if (fe !== "__ALL__" && inferEspecialidad(r.Nombre_kit) !== fe) return false;
    if (fn !== "__ALL__" && r.Nombre !== fn) return false;
    if (fu !== "__ALL__" && r.Usuario !== fu) return false;
    if (fd && r.Fecha_iso && r.Fecha_iso < fd) return false;
    if (fh && r.Fecha_iso && r.Fecha_iso > fh) return false;
    return true;
  });

  refreshDashboard();
}

function resetFilters() {
  document.getElementById("filtroDesde").value    = "";
  document.getElementById("filtroHasta").value    = "";
  document.getElementById("filtroFarmacia").value = "__ALL__";
  document.getElementById("filtroTurno").value = "__ALL__";
  document.getElementById("filtroTipo").value = "__ALL__";
  document.getElementById("filtroQuirofano").value = "__ALL__";
  document.getElementById("filtroKit").value = "__ALL__";
  document.getElementById("filtroEspecialidad").value = "__ALL__";
  document.getElementById("filtroNombre").value = "__ALL__";
  document.getElementById("filtroUsuario").value = "__ALL__";

  filteredData = originalData.slice();
  refreshDashboard();
}

// ======================================================================
// Exportar datos filtrados
// ======================================================================

function exportData() {
  if (!filteredData.length) {
    alert("No hay datos para exportar.");
    return;
  }
  const headers = Object.keys(filteredData[0]);
  const csvLines = [];
  csvLines.push(headers.join(","));
  filteredData.forEach(function(row){
    const line = headers.map(function(h){
      const v = row[h] == null ? "" : String(row[h]);
      return "\"" + v.replace(/"/g,'""') + "\"";
    }).join(",");
    csvLines.push(line);
  });
  const blob = new Blob([csvLines.join("\n")], {type:"text/csv"});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement("a");
  a.href     = url;
  a.download = "datos_quirofanos.csv";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// ======================================================================
// Calidad de datos
// ======================================================================

function checkDataQuality(data) {
    const total = data.length;
    if (total === 0) return null;
    
    const issues = [];
    const sinQuirofano = data.filter(function(r){
        return !r.Quirofano || r.Quirofano === "";
    }).length;
    if (sinQuirofano > 0) {
        issues.push(
            sinQuirofano + " registros sin quirófano asignado (" +
            (sinQuirofano/total*100).toFixed(1) + "%)"
        );
    }
    const sinKit = data.filter(function(r){
        return !r.Nombre_kit || r.Nombre_kit === "";
    }).length;
    if (sinKit > 0) {
        issues.push(
            sinKit + " registros sin kit asignado (" +
            (sinKit/total*100).toFixed(1) + "%)"
        );
    }
    return issues.length > 0 ? issues : null;
}

function mostrarAlertasCalidad(issues) {
    const alertDiv = document.getElementById("dataQualityAlert");
    const messageDiv = document.getElementById("dataQualityMessage");
    
    if (issues && issues.length > 0) {
        messageDiv.innerHTML =
            "<strong>Se detectaron las siguientes situaciones:</strong><br>" +
            issues.join("<br>");
        alertDiv.style.display = "block";
    } else {
        alertDiv.style.display = "none";
    }
}

// ======================================================================
// Carga real desde Google Sheets (CSV público)
// ======================================================================

async function loadSheetData() {
    showLoading();
    try {
        // URL CSV pública de la hoja específica
        // Nota: SHEET_NAME debe coincidir EXACTO con el nombre de la pestaña "Registros"
        const csvURL =
          "https://docs.google.com/spreadsheets/d/" +
          encodeURIComponent(SHEET_ID) +
          "/gviz/tq?tqx=out:csv&sheet=" +
          encodeURIComponent(SHEET_NAME);

        const resp = await fetch(csvURL);
        if (!resp.ok) {
            throw new Error("No se pudo leer la hoja (resp " + resp.status + ")");
        }

        const rawCSV = await resp.text();

        // 1) Parsear CSV en filas
        const rows = parseCSV(rawCSV);
        // 2) Convertir filas en objetos clave-valor
        const sheetObjects = rowsToObjects(rows);

        // 3) Normalizar al formato interno esperado
        originalData = sheetObjects.map(function(r){
            // nombres esperados según tu sheet:
            // Fecha, Farmacia, Turno, Tipo, Nombre,
            // Quirófano Nro, Codigo_kit, Nombre_kit,
            // Cantidad, Observaciones, Usuario, Timestamp

            const Fecha         = r["Fecha"] || r["fecha"] || "";
            const Fecha_iso     = toISO(Fecha);
            const Cantidad_raw  = r["Cantidad"] || r["cantidad"] || "";
            const Cantidad_num  = toNumber(Cantidad_raw);
            const Timestamp_raw = r["Timestamp"] || r["timestamp"] || "";
            const Timestamp_obj = parseTS(Timestamp_raw);

            const Qraw = r["Quirófano Nro"] || r["Quirofano Nro"] || r["Quirófano"] || r["Quirofano"] || "";

            return {
                Fecha:        Fecha,
                Fecha_iso:    Fecha_iso,
                Farmacia:     r["Farmacia"] || r["farmacia"] || "",
                Turno:        r["Turno"] || r["turno"] || "",
                Tipo:         r["Tipo"] || r["tipo"] || "",
                Nombre:       r["Nombre"] || r["nombre"] || "",
                Quirofano:    normalizeQuirfano(Qraw),
                Nombre_kit:   r["Nombre_kit"] || r["Nombre kit"] || r["Nombre kit "] || r["nombre_kit"] || "",
                Cantidad:     Cantidad_raw,
                Cantidad_num: Cantidad_num,
                Observaciones: r["Observaciones"] || r["observaciones"] || "",
                Usuario:      r["Usuario"] || r["usuario"] || "",
                Timestamp:    Timestamp_raw,
                Timestamp_obj: Timestamp_obj
            };
        });

        filteredData = originalData.slice();

        populateFilters();
        refreshDashboard();
    } catch (err) {
        console.error("Error cargando hoja:", err);
        alert("No se pudo cargar datos reales desde la hoja Registros. ¿Está compartida como 'cualquiera con el enlace - lector'? Se usarán 0 filas.");
        originalData = [];
        filteredData = [];
        populateFilters();
        refreshDashboard();
    } finally {
        hideLoading();
    }
}

// ======================================================================
// Login local (sin backend server)
// ======================================================================

async function doLogin(username, password) {
  showLoading();
  try {
    const expected = AUTH_MAP[username];
    if (!expected || expected !== password) {
        hideLoading();
        showLoginError("Credenciales inválidas");
        return;
    }

    currentUser  = username;
    currentToken = "token_local_" + Date.now();

    document.getElementById("activeUser").textContent = currentUser;
    showDashboardScreen();

    // Cargar datos reales desde la hoja
    await loadSheetData();

  } catch (err) {
    hideLoading();
    console.error(err);
    showLoginError("Fallo interno");
  }
}

// Cerrar sesión
function doLogout() {
  currentUser  = null;
  currentToken = null;
  showLoginScreen();
}

// ======================================================================
// Render principal
// ======================================================================

function refreshDashboard() {
  const k = calcKPIs(filteredData);
  renderKPIs(k);

  const kEspecializados = calcKPIsEspecializados(filteredData);
  renderKPIsEspecializados(kEspecializados);

  destroyCharts();
  createChartDiaFarmacia();
  createTurnoChart();
  createTipoChart();
  createTopAnestesiologosChart();
  createTopCirculantesChart();
  createPersonalQuirfanoChart();
  createTopKitsChart();
  createKitsCantidadChart();
  createKitsQuirfanoChart();
  createRotacionQuirfanosChart();
  createEficienciaPersonalChart();
  createPatronesConsumoChart();
  createCurvaABCChart();
  createPrevisionConsumoChart();
  createEstacionalidadChart();
  createSegmentEspecialidadTurnoChart();
  createSegmentQuirofanoTipoChart();
  createSegmentFarmaciaEspecialidadChart();

  updateDataTable();

  const issues = checkDataQuality(filteredData);
  mostrarAlertasCalidad(issues);
}

// ======================================================================
// Init al cargar DOM
// ======================================================================

document.addEventListener("DOMContentLoaded", function(){

  document.getElementById("loginForm").addEventListener("submit", function(ev){
    ev.preventDefault();
    const u = document.getElementById("usuario").value.trim().toLowerCase();
    const p = document.getElementById("codigo").value.trim();
    doLogin(u, p);
  });

  document.getElementById("filtroDesde").addEventListener("change", applyFilters);
  document.getElementById("filtroHasta").addEventListener("change", applyFilters);
  document.getElementById("filtroFarmacia").addEventListener("change", applyFilters);
  document.getElementById("filtroTurno").addEventListener("change", applyFilters);
  document.getElementById("filtroTipo").addEventListener("change", applyFilters);
  document.getElementById("filtroQuirofano").addEventListener("change", applyFilters);
  document.getElementById("filtroKit").addEventListener("change", applyFilters);
  document.getElementById("filtroEspecialidad").addEventListener("change", applyFilters);
  document.getElementById("filtroNombre").addEventListener("change", applyFilters);
  document.getElementById("filtroUsuario").addEventListener("change", applyFilters);
  document.getElementById("btnReset").addEventListener("click", resetFilters);
  document.getElementById("exportData").addEventListener("click", exportData);
  document.getElementById("logoutBtn").addEventListener("click", doLogout);

  // Inicializar tooltips de Bootstrap
  const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
  const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));

  // flujo inicial (normalmente no hay sesión previa en GitHub Pages)
  if (AUTH_OK_INIT && SESSION_TOKEN) {
    currentUser  = INITIAL_USER || "";
    currentToken = SESSION_TOKEN || "";
    document.getElementById("activeUser").textContent = currentUser;
    showDashboardScreen();
    // Cargamos la hoja directamente si ya está "logueado"
    loadSheetData();
  } else {
    showLoginScreen();
  }
});
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablero de Quirófanos - Ministerio de Trabajo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        :root {
            --bg-main: #0f172a;
            --bg-panel: #1e293b;
            --bg-card: #334155;
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
            --accent: #38bdf8;
            --border-col: #475569;
            --radius-lg: 1rem;
            --radius-sm: 0.5rem;
            --gap-lg: 1.5rem;
            --gap-sm: 0.75rem;
            --font-main: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
        }
        
        body {
            background-color: var(--bg-main);
            color: var(--text-main);
            font-family: var(--font-main);
            margin: 0;
            line-height: 1.4;
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-bottom: 1px solid var(--border-col);
        }
        
        .card {
            background-color: var(--bg-panel);
            border: 1px solid var(--border-col);
            border-radius: var(--radius-lg);
            margin-bottom: 20px;
            transition: transform 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background-color: var(--bg-card);
            color: var(--text-main);
            border-bottom: 1px solid var(--border-col);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0 !important;
        }
        
        .stat-card {
            text-align: center;
            padding: 20px;
            border-radius: var(--radius-lg);
            color: white;
            margin-bottom: 20px;
            transition: transform 0.3s;
            background-color: var(--bg-card);
            border: 1px solid var(--border-col);
            display: flex;
            flex-direction: column;
            min-height: 120px;
            justify-content: space-between;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card .kpi-label {
            font-size: 0.75rem;
            color: var(--text-dim);
            font-weight: 500;
        }
        
        .stat-card .kpi-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--accent);
        }
        
        .stat-card .kpi-foot {
            font-size: 0.7rem;
            color: var(--text-dim);
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }
        
        .table-container {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .filter-section {
            background-color: var(--bg-panel);
            padding: 15px;
            border-radius: var(--radius-lg);
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 1px solid var(--border-col);
        }
        
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(15, 23, 42, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--bg-card);
            border-top: 5px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .tab-content {
            padding-top: 20px;
        }
        
        .nav-tabs .nav-link.active {
            background-color: var(--accent);
            color: var(--bg-main);
            border-color: var(--accent);
        }
        
        .nav-tabs .nav-link {
            color: var(--accent);
            background-color: var(--bg-panel);
            border-color: var(--border-col);
        }
        
        .data-quality-alert {
            background-color: rgba(55, 65, 81, 0.8);
            border: 1px solid var(--border-col);
            border-radius: var(--radius-sm);
            padding: 10px;
            margin-bottom: 20px;
        }
        
        .btn-primary {
            background-color: var(--accent);
            border-color: var(--accent);
            color: var(--bg-main);
        }
        
        .btn-secondary {
            background-color: var(--bg-card);
            border-color: var(--border-col);
            color: var(--text-main);
        }
        
        .form-control, .form-select {
            background-color: var(--bg-card);
            border: 1px solid var(--border-col);
            color: var(--text-main);
        }
        
        .form-control:focus, .form-select:focus {
            background-color: var(--bg-card);
            border-color: var(--accent);
            color: var(--text-main);
            box-shadow: 0 0 0 0.25rem rgba(56, 189, 248, 0.25);
        }
        
        .table {
            color: var(--text-main);
        }
        
        .table thead th {
            background-color: var(--bg-card);
            border-bottom: 1px solid var(--border-col);
            color: var(--text-dim);
            font-weight: 600;
            font-size: 0.8rem;
        }
        
        .table tbody tr:hover {
            background-color: rgba(56, 189, 248, 0.1);
        }
        
        .table tbody td {
            border-bottom: 1px solid var(--border-col);
        }
        
        footer {
            background-color: var(--bg-panel);
            border-top: 1px solid var(--border-col);
            padding: 20px;
            margin-top: 40px;
            color: var(--text-dim);
            font-size: 0.8rem;
            text-align: center;
        }
        
        .user-info {
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-top: 5px;
        }
        
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
        }
        
        .login-card {
            background-color: var(--bg-panel);
            border: 1px solid var(--border-col);
            border-radius: var(--radius-lg);
            padding: 2rem;
            width: 320px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.7);
        }
        
        .login-error {
            background-color: rgba(127, 29, 29, 0.8);
            border: 1px solid #dc2626;
            color: #fecaca;
            font-size: 0.8rem;
            border-radius: var(--radius-sm);
            padding: 0.5rem 0.75rem;
            margin-bottom: 1rem;
            text-align: center;
            word-break: break-word;
        }
        
        .chart-note {
            font-size: 0.7rem;
            color: var(--text-dim);
            margin-top: 0.5rem;
            line-height: 1.3;
        }
        
        .footnote {
            font-size: 0.7rem;
            color: var(--text-dim);
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <!-- Pantalla de Login -->
    <div id="loginScreen" class="login-container" style="display: none;">
        <div class="login-card">
            <h1 class="text-center mb-4">Ingreso al Tablero de Quirófanos</h1>
            
            <div id="loginError" class="login-error" style="display: none;"></div>
            
            <form id="loginForm">
                <div class="mb-3">
                    <label for="usuario" class="form-label">Usuario</label>
                    <input type="text" class="form-control" id="usuario" required>
                </div>
                
                <div class="mb-3">
                    <label for="codigo" class="form-label">Código de acceso</label>
                    <input type="password" class="form-control" id="codigo" required>
                </div>
                
                <button type="submit" class="btn btn-primary w-100">Acceder</button>
            </form>
            
            <div class="user-info mt-4 text-center">
                Acceso restringido. Ministerio de Trabajo, Empleo y Seguridad Social.<br>
                Área de Apoyo Médico IPS.
            </div>
        </div>
    </div>

    <!-- Pantalla Principal del Tablero -->
    <div id="dashboardScreen">
        <div class="container-fluid">
            <div class="dashboard-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="mb-1"><i class="bi bi-graph-up"></i> Tablero de Consumo de Kits en Quirófano</h1>
                        <div class="user-info">
                            Usuario activo: <span id="activeUser">Invitado</span><br>
                            Datos internos, acceso restringido. Sesión temporal.
                        </div>
                    </div>
                    <div>
                        <button class="btn btn-outline-light" id="logoutBtn">
                            <i class="bi bi-box-arrow-right"></i> Cerrar Sesión
                        </button>
                    </div>
                </div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
            </div>

            <div class="data-quality-alert" id="dataQualityAlert" style="display: none;">
                <h5><i class="bi bi-exclamation-triangle-fill"></i> Alerta de Calidad de Datos</h5>
                <p id="dataQualityMessage"></p>
            </div>

            <div class="filter-section">
                <div class="row">
                    <div class="col-md-3">
                        <label for="filtroDesde" class="form-label">Desde (Fecha)</label>
                        <input type="date" class="form-control" id="filtroDesde">
                    </div>
                    <div class="col-md-3">
                        <label for="filtroHasta" class="form-label">Hasta (Fecha)</label>
                        <input type="date" class="form-control" id="filtroHasta">
                    </div>
                    <div class="col-md-3">
                        <label for="filtroFarmacia" class="form-label">Farmacia / Almacén</label>
                        <select class="form-select" id="filtroFarmacia">
                            <option value="__ALL__">Todas</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-secondary w-100" id="btnReset">
                            <i class="bi bi-arrow-clockwise"></i> Limpiar filtros
                        </button>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="kpi-label">Descargas filtradas</div>
                        <div class="kpi-value" id="kpiDescargas">0</div>
                        <div class="kpi-foot">Filas registradas</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="kpi-label">Promedio diario</div>
                        <div class="kpi-value" id="kpiPromedioDiario">0</div>
                        <div class="kpi-foot">Descargas / día</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="kpi-label">Farmacias activas</div>
                        <div class="kpi-value" id="kpiFarmaciasActivas">0</div>
                        <div class="kpi-foot">en rango filtrado</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="kpi-label">Total de kits</div>
                        <div class="kpi-value" id="kpiTotalKits">0</div>
                        <div class="kpi-foot">unidades consumidas</div>
                    </div>
                </div>
            </div>

            <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab" aria-controls="overview" aria-selected="true">Visión General</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="personnel-tab" data-bs-toggle="tab" data-bs-target="#personnel" type="button" role="tab" aria-controls="personnel" aria-selected="false">Personal</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="kits-tab" data-bs-toggle="tab" data-bs-target="#kits" type="button" role="tab" aria-controls="kits" aria-selected="false">Kits</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="data-tab" data-bs-toggle="tab" data-bs-target="#data" type="button" role="tab" aria-controls="data" aria-selected="false">Datos</button>
                </li>
            </ul>

            <div class="tab-content" id="dashboardTabsContent">
                <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Descargas por día y farmacia</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="chartDiaFarmacia"></canvas>
                                    </div>
                                    <div class="chart-note">
                                        Métrica: número de registros (descargas de kits) por Fecha y Farmacia/Almacén.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Registros por Turno</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="turnoChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Distribución por Tipo</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="tipoChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="personnel" role="tabpanel" aria-labelledby="personnel-tab">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Anestesiólogos Más Activos</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="topAnestesiologosChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Circulantes Más Activos</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="topCirculantesChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Distribución de Personal por Quirófano</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="personalQuirfanoChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="kits" role="tabpanel" aria-labelledby="kits-tab">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Kits Más Utilizados</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="topKitsChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Cantidad Total de Kits por Tipo</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="kitsCantidadChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Distribución de Kits por Quirófano</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="kitsQuirfanoChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="data" role="tabpanel" aria-labelledby="data-tab">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5>Registros recientes (filtrados)</h5>
                            <button class="btn btn-sm btn-outline-light" id="exportData">
                                <i class="bi bi-download"></i> Exportar Datos
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="table table-striped table-hover" id="dataTable">
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Farmacia</th>
                                            <th>Descripción almacén</th>
                                            <th>Turno</th>
                                            <th>Tipo</th>
                                            <th>Nombre</th>
                                            <th>Quirófano</th>
                                            <th>Kit</th>
                                            <th>Cantidad</th>
                                            <th>Usuario</th>
                                            <th>Timestamp</th>
                                        </tr>
                                    </thead>
                                    <tbody id="dataTableBody">
                                        <!-- Los datos se cargarán aquí dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="footnote">
                                Muestra hasta 100 filas más recientes según filtros aplicados.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        Ministerio de Trabajo, Empleo y Seguridad Social - Área de Apoyo Médico IPS<br>
        Control de stock por quirófano
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Variables globales
        let originalData = [];
        let filteredData = [];
        let charts = {};
        let currentUser = null;
        let sessionToken = null;

        // Configuración de autenticación (simulada para demostración)
        const AUTH_MAP = {
            "dbmeza": "3704196",
            "clawes": "524307",
            "memarti": "4187108"
        };

        // ID de la hoja de cálculo de Google Sheets
        const SPREADSHEET_ID = '13mzYK7HsvwiKyMXDpZJ3d1fLRvkwPYbOKUeedYSUh68';
        const SHEET_NAME = 'Registros';

        // Funciones de sesión (simuladas para demostración)
        function createSession(user) {
            sessionToken = btoa(JSON.stringify({
                user: user,
                ts: Date.now()
            }));
            localStorage.setItem('quirofanos_session', sessionToken);
            return sessionToken;
        }

        function getSession(token) {
            if (!token) return null;
            try {
                const payload = JSON.parse(atob(token));
                // Verificar si la sesión ha expirado (30 minutos)
                if (Date.now() - payload.ts > 30 * 60 * 1000) {
                    return null;
                }
                return payload;
            } catch (err) {
                return null;
            }
        }

        // Función para cargar los datos
        async function loadData() {
            showLoading();
            try {
                // URL para obtener los datos como CSV
                const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:csv&sheet=${SHEET_NAME}`;
                
                // Realizar la petición fetch para obtener los datos
                const response = await fetch(url);
                const csvText = await response.text();
                
                // Procesar el CSV a JSON
                originalData = csvToJson(csvText);
                
                // Aplicar corrección y armonización de datos
                originalData = harmonizeData(originalData);
                
                // Inicializar los datos filtrados con todos los datos
                filteredData = [...originalData];
                
                // Actualizar la interfaz
                updateDashboard();
                populateFilters();
                updateDataTable();
                
                hideLoading();
            } catch (error) {
                console.error('Error al cargar los datos:', error);
                showError('No se pudieron cargar los datos. Por favor, inténtelo de nuevo más tarde.');
                hideLoading();
            }
        }

        // Función para convertir CSV a JSON
        function csvToJson(csvText) {
            const lines = csvText.split('\n');
            const headers = lines[0].split(',').map(header => header.trim().replace(/"/g, ''));
            const result = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                
                const values = lines[i].split(',').map(value => value.trim().replace(/"/g, ''));
                const obj = {};
                
                for (let j = 0; j < headers.length; j++) {
                    obj[headers[j]] = values[j] || '';
                }
                
                result.push(obj);
            }
            
            return result;
        }

        // Función para armonizar y corregir datos
        function harmonizeData(data) {
            return data.map(row => {
                // Crear una copia para no modificar el original
                const newRow = { ...row };
                
                // Corregir formatos de fecha
                if (newRow.Fecha) {
                    // Convertir diferentes formatos de fecha a un formato estándar
                    newRow.Fecha_iso = toISO(newRow.Fecha);
                }
                
                // Normalizar nombres de quirófanos
                if (newRow['Quirófano Nro']) {
                    newRow['Quirófano Nro'] = normalizeQuirfano(newRow['Quirófano Nro']);
                }
                
                // Asegurar que la cantidad sea un número
                if (newRow.Cantidad) {
                    newRow.Cantidad_num = toNumber(newRow.Cantidad);
                }
                
                // Normalizar tipos
                if (newRow.Tipo) {
                    newRow.Tipo = newRow.Tipo.trim();
                }
                
                // Normalizar turnos
                if (newRow.Turno) {
                    newRow.Turno = newRow.Turno.trim();
                }
                
                // Procesar timestamp
                if (newRow.Timestamp) {
                    newRow.Timestamp_obj = parseTS(newRow.Timestamp);
                }
                
                return newRow;
            });
        }

        // Función para normalizar fechas
        function toISO(dateStr) {
            if (!dateStr) return null;
            
            // Si ya está en formato DD/MM/YYYY, convertir a ISO
            if (/^\d{2}\/\d{2}\/\d{4}$/.test(dateStr)) {
                const [dd, mm, yyyy] = dateStr.split('/');
                return `${yyyy}-${mm}-${dd}`;
            }
            
            // Intentar convertir otros formatos
            try {
                const date = new Date(dateStr);
                if (!isNaN(date.getTime())) {
                    const day = date.getDate().toString().padStart(2, '0');
                    const month = (date.getMonth() + 1).toString().padStart(2, '0');
                    const year = date.getFullYear();
                    return `${year}-${month}-${day}`;
                }
            } catch (e) {
                console.error('Error al normalizar fecha:', dateStr, e);
            }
            
            return null; // Devolver null si no se puede convertir
        }

        // Función para normalizar números de quirófano
        function normalizeQuirfano(quirfanoStr) {
            if (!quirfanoStr) return '';
            
            // Si es solo un número, añadir 'Q' al principio
            if (/^\d+$/.test(quirfanoStr)) {
                return `Q${quirfanoStr}`;
            }
            
            // Si ya tiene formato Qx, devolverlo
            if (/^Q\d+$/.test(quirfanoStr)) {
                return quirfanoStr;
            }
            
            return quirfanoStr;
        }

        // Función para convertir a número
        function toNumber(x) {
            if (x == null || x === "") return 0;
            const n = Number(String(x).replace(",", "."));
            return Number.isFinite(n) ? n : 0;
        }

        // Función para parsear timestamp
        function parseTS(ts) {
            if (!ts) return null;
            const parts = ts.split(" ");
            const baseISO = toISO(parts[0] || "");
            if (!baseISO) return null;
            const hhmmss = parts[1] ? parts[1] : "00:00:00";
            const d = new Date(baseISO + "T" + hhmmss);
            if (isNaN(d.getTime())) return null;
            return d;
        }

        // Función para mostrar el indicador de carga
        function showLoading() {
            document.getElementById('loading').style.display = 'flex';
        }

        // Función para ocultar el indicador de carga
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // Función para mostrar un mensaje de error
        function showError(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.querySelector('.container-fluid').prepend(alertDiv);
        }

        // Función para actualizar el tablero
        function updateDashboard() {
            // Actualizar tarjetas de estadísticas
            updateStatCards();
            
            // Actualizar gráficos
            updateCharts();
        }

        // Función para actualizar las tarjetas de estadísticas
        function updateStatCards() {
            // Calcular KPIs
            const kpis = calcKPIs(filteredData);
            
            // Actualizar KPIs en la interfaz
            document.getElementById('kpiDescargas').textContent = kpis.total.toLocaleString("es-PY");
            document.getElementById('kpiPromedioDiario').textContent = kpis.prom.toFixed(2);
            document.getElementById('kpiFarmaciasActivas').textContent = kpis.nFarm.toLocaleString("es-PY");
            document.getElementById('kpiTotalKits').textContent = kpis.unidades.toLocaleString("es-PY");
        }

        // Función para calcular KPIs
        function calcKPIs(data) {
            const total = data.length;
            const unidades = data.reduce((s, r) => s + (r.Cantidad_num || 0), 0);
            const farmSet = new Set(data.map(r => r.Farmacia));
            const nFarm = farmSet.size;
            const diasSet = new Set(data.map(r => r.Fecha_iso).filter(d => d));
            const nDias = diasSet.size || 1;
            const prom = total / nDias;
            return { total, unidades, nFarm, prom };
        }

        // Función para actualizar los gráficos
        function updateCharts() {
            // Destruir gráficos existentes
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            
            // Crear nuevos gráficos
            createChartDiaFarmacia();
            createTurnoChart();
            createTipoChart();
            createTopAnestesiologosChart();
            createTopCirculantesChart();
            createPersonalQuirfanoChart();
            createTopKitsChart();
            createKitsCantidadChart();
            createKitsQuirfanoChart();
        }

        // Función para crear el gráfico de descargas por día y farmacia
        function createChartDiaFarmacia() {
            const ctx = document.getElementById('chartDiaFarmacia').getContext('2d');
            
            // Agrupar datos por fecha y farmacia
            const M = {};
            filteredData.forEach(r => {
                if (!r.Fecha_iso || !r.Farmacia) return;
                if (!M[r.Fecha_iso]) M[r.Fecha_iso] = {};
                if (!M[r.Fecha_iso][r.Farmacia]) M[r.Fecha_iso][r.Farmacia] = 0;
                M[r.Fecha_iso][r.Farmacia] += 1;
            });

            const fechas = Object.keys(M).sort();
            const farmCodes = [...new Set(fechas.flatMap(F => Object.keys(M[F])))].sort();

            const labels = fechas.map(F => {
                const [y,m,d] = F.split("-");
                return d + "/" + m + "/" + y;
            });

            const datasets = farmCodes.map(code => {
                const serie = fechas.map(F => M[F][code] || 0);
                return {
                    label: code,
                    data: serie,
                    borderWidth: 2,
                    tension: 0.2,
                    fill: false
                };
            });

            charts.chartDiaFarmacia = new Chart(ctx, {
                type: "line",
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: "index", intersect: false },
                    plugins: {
                        legend: { position: "bottom" },
                        tooltip: {
                            callbacks: {
                                label: c => `${c.dataset.label}: ${c.parsed.y} descargas`
                            }
                        }
                    },
                    scales: {
                        x: { title: { display: true, text: "Fecha" } },
                        y: { beginAtZero: true, title: { display: true, text: "Descargas" } }
                    }
                }
            });
        }

        // Función para crear el gráfico de registros por turno
        function createTurnoChart() {
            const ctx = document.getElementById('turnoChart').getContext('2d');
            
            // Agrupar datos por turno
            const turnoData = {};
            filteredData.forEach(row => {
                if (row.Turno) {
                    turnoData[row.Turno] = (turnoData[row.Turno] || 0) + 1;
                }
            });
            
            charts.turnoChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(turnoData),
                    datasets: [{
                        data: Object.values(turnoData),
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 206, 86, 0.7)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // Función para crear el gráfico de distribución por tipo
        function createTipoChart() {
            const ctx = document.getElementById('tipoChart').getContext('2d');
            
            // Agrupar datos por tipo
            const tipoData = {};
            filteredData.forEach(row => {
                if (row.Tipo) {
                    tipoData[row.Tipo] = (tipoData[row.Tipo] || 0) + 1;
                }
            });
            
            charts.tipoChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(tipoData),
                    datasets: [{
                        data: Object.values(tipoData),
                        backgroundColor: [
                            'rgba(153, 102, 255, 0.7)',
                            'rgba(255, 159, 64, 0.7)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // Función para crear el gráfico de anestesiólogos más activos
        function createTopAnestesiologosChart() {
            const ctx = document.getElementById('topAnestesiologosChart').getContext('2d');
            
            // Filtrar solo anestesiólogos y agrupar por nombre
            const anestesiologosData = {};
            filteredData.filter(row => row.Tipo === 'Anestesiólogo').forEach(row => {
                if (row.Nombre) {
                    anestesiologosData[row.Nombre] = (anestesiologosData[row.Nombre] || 0) + 1;
                }
            });
            
            // Ordenar y tomar los 10 principales
            const sortedAnestesiologos = Object.entries(anestesiologosData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            charts.topAnestesiologosChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedAnestesiologos.map(item => item[0]),
                    datasets: [{
                        label: 'Registros',
                        data: sortedAnestesiologos.map(item => item[1]),
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Función para crear el gráfico de circulantes más activos
        function createTopCirculantesChart() {
            const ctx = document.getElementById('topCirculantesChart').getContext('2d');
            
            // Filtrar solo circulantes y agrupar por nombre
            const circulantesData = {};
            filteredData.filter(row => row.Tipo === 'Circulante').forEach(row => {
                if (row.Nombre) {
                    circulantesData[row.Nombre] = (circulantesData[row.Nombre] || 0) + 1;
                }
            });
            
            // Ordenar y tomar los 10 principales
            const sortedCirculantes = Object.entries(circulantesData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            charts.topCirculantesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedCirculantes.map(item => item[0]),
                    datasets: [{
                        label: 'Registros',
                        data: sortedCirculantes.map(item => item[1]),
                        backgroundColor: 'rgba(75, 192, 192, 0.7)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Función para crear el gráfico de distribución de personal por quirófano
        function createPersonalQuirfanoChart() {
            const ctx = document.getElementById('personalQuirfanoChart').getContext('2d');
            
            // Agrupar datos por quirófano y tipo
            const personalData = {};
            filteredData.forEach(row => {
                const quirfano = row['Quirófano Nro'] || 'Sin asignar';
                const tipo = row.Tipo || 'Sin tipo';
                
                if (!personalData[quirfano]) {
                    personalData[quirfano] = {
                        'Anestesiólogo': 0,
                        'Circulante': 0
                    };
                }
                
                if (personalData[quirfano][tipo] !== undefined) {
                    personalData[quirfano][tipo]++;
                }
            });
            
            const quirfanos = Object.keys(personalData);
            const anestesiologosData = quirfanos.map(q => personalData[q]['Anestesiólogo']);
            const circulantesData = quirfanos.map(q => personalData[q]['Circulante']);
            
            charts.personalQuirfanoChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: quirfanos,
                    datasets: [
                        {
                            label: 'Anestesiólogos',
                            data: anestesiologosData,
                            backgroundColor: 'rgba(153, 102, 255, 0.7)',
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Circulantes',
                            data: circulantesData,
                            backgroundColor: 'rgba(255, 159, 64, 0.7)',
                            borderColor: 'rgba(255, 159, 64, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Función para crear el gráfico de kits más utilizados
        function createTopKitsChart() {
            const ctx = document.getElementById('topKitsChart').getContext('2d');
            
            // Agrupar datos por nombre de kit
            const kitsData = {};
            filteredData.forEach(row => {
                if (row.Nombre_kit && row.Nombre_kit !== '*') {
                    kitsData[row.Nombre_kit] = (kitsData[row.Nombre_kit] || 0) + (row.Cantidad_num || 0);
                }
            });
            
            // Ordenar y tomar los 10 principales
            const sortedKits = Object.entries(kitsData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            charts.topKitsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedKits.map(item => item[0]),
                    datasets: [{
                        label: 'Cantidad',
                        data: sortedKits.map(item => item[1]),
                        backgroundColor: 'rgba(255, 99, 132, 0.7)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Función para crear el gráfico de cantidad total de kits por tipo
        function createKitsCantidadChart() {
            const ctx = document.getElementById('kitsCantidadChart').getContext('2d');
            
            // Agrupar datos por tipo y sumar cantidades
            const kitsPorTipo = {};
            filteredData.forEach(row => {
                const tipo = row.Tipo || 'Sin tipo';
                kitsPorTipo[tipo] = (kitsPorTipo[tipo] || 0) + (row.Cantidad_num || 0);
            });
            
            charts.kitsCantidadChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(kitsPorTipo),
                    datasets: [{
                        data: Object.values(kitsPorTipo),
                        backgroundColor: [
                            'rgba(153, 102, 255, 0.7)',
                            'rgba(255, 159, 64, 0.7)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // Función para crear el gráfico de distribución de kits por quirófano
        function createKitsQuirfanoChart() {
            const ctx = document.getElementById('kitsQuirfanoChart').getContext('2d');
            
            // Agrupar datos por quirófano y sumar cantidades
            const kitsPorQuirfano = {};
            filteredData.forEach(row => {
                const quirfano = row['Quirófano Nro'] || 'Sin asignar';
                kitsPorQuirfano[quirfano] = (kitsPorQuirfano[quirfano] || 0) + (row.Cantidad_num || 0);
            });
            
            // Ordenar quirófanos
            const sortedQuirfanos = Object.entries(kitsPorQuirfano)
                .sort((a, b) => b[1] - a[1]);
            
            charts.kitsQuirfanoChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedQuirfanos.map(item => item[0]),
                    datasets: [{
                        label: 'Cantidad de Kits',
                        data: sortedQuirfanos.map(item => item[1]),
                        backgroundColor: 'rgba(75, 192, 192, 0.7)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Función para poblar los filtros
        function populateFilters() {
            // Poblar filtro de farmacia
            const farmaciaFilter = document.getElementById('filtroFarmacia');
            const farmacias = [...new Set(originalData.map(row => row.Farmacia).filter(f => f))];
            
            // Limpiar opciones existentes excepto la primera
            while (farmaciaFilter.options.length > 1) {
                farmaciaFilter.remove(1);
            }
            
            // Añadir nuevas opciones
            farmacias.forEach(farmacia => {
                const option = document.createElement('option');
                option.value = farmacia;
                option.textContent = farmacia;
                farmaciaFilter.appendChild(option);
            });
        }

        // Función para actualizar la tabla de datos
        function updateDataTable() {
            const tableBody = document.getElementById('dataTableBody');
            tableBody.innerHTML = '';
            
            // Ordenar por timestamp descendente
            const sortedData = [...filteredData].sort((a, b) => {
                return (b.Timestamp_obj || 0) - (a.Timestamp_obj || 0);
            });
            
            // Limitar a 100 filas
            const limitedData = sortedData.slice(0, 100);
            
            limitedData.forEach(row => {
                const tr = document.createElement('tr');
                
                // Crear celdas para cada columna
                const columns = [
                    'Fecha', 'Farmacia', 'Farmacia_desc', 'Turno', 'Tipo', 'Nombre', 
                    'Quirófano Nro', 'Nombre_kit', 'Cantidad', 'Usuario', 'Timestamp'
                ];
                
                columns.forEach((column, idx) => {
                    const td = document.createElement('td');
                    td.textContent = row[column] || '';
                    
                    // Alinear a la derecha la columna de cantidad
                    if (idx === 8) {
                        td.style.textAlign = 'right';
                    }
                    
                    tr.appendChild(td);
                });
                
                tableBody.appendChild(tr);
            });
        }

        // Función para aplicar filtros
        function applyFilters() {
            const fd = document.getElementById('filtroDesde').value || null;
            const fh = document.getElementById('filtroHasta').value || null;
            const ff = document.getElementById('filtroFarmacia').value || '__ALL__';
            
            // Filtrar datos
            filteredData = originalData.filter(row => {
                if (ff !== '__ALL__' && row.Farmacia !== ff) return false;
                if (fd && row.Fecha_iso && row.Fecha_iso < fd) return false;
                if (fh && row.Fecha_iso && row.Fecha_iso > fh) return false;
                return true;
            });
            
            // Actualizar la interfaz
            updateDashboard();
            updateDataTable();
        }

        // Función para restablecer filtros
        function resetFilters() {
            document.getElementById('filtroDesde').value = '';
            document.getElementById('filtroHasta').value = '';
            document.getElementById('filtroFarmacia').value = '__ALL__';
            
            filteredData = [...originalData];
            updateDashboard();
            updateDataTable();
        }

        // Función para exportar datos
        function exportData() {
            // Convertir datos filtrados a CSV
            const headers = Object.keys(filteredData[0] || {});
            const csvContent = [
                headers.join(','),
                ...filteredData.map(row => headers.map(header => `"${row[header] || ''}"`).join(','))
            ].join('\n');
            
            // Crear un blob y descargar
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `datos_quirofanos_${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Función para mostrar la pantalla de login
        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('dashboardScreen').style.display = 'none';
        }

        // Función para mostrar la pantalla del tablero
        function showDashboardScreen() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboardScreen').style.display = 'block';
        }

        // Función para iniciar sesión
        function login(username, password) {
            if (AUTH_MAP[username] && AUTH_MAP[username] === password) {
                currentUser = username;
                sessionToken = createSession(username);
                document.getElementById('activeUser').textContent = username;
                showDashboardScreen();
                loadData();
                return true;
            } else {
                document.getElementById('loginError').textContent = 'Credenciales inválidas';
                document.getElementById('loginError').style.display = 'block';
                return false;
            }
        }

        // Función para cerrar sesión
        function logout() {
            currentUser = null;
            sessionToken = null;
            localStorage.removeItem('quirofanos_session');
            showLoginScreen();
        }

        // Función para verificar si hay una sesión activa
        function checkActiveSession() {
            const savedToken = localStorage.getItem('quirofanos_session');
            if (savedToken) {
                const session = getSession(savedToken);
                if (session) {
                    currentUser = session.user;
                    sessionToken = savedToken;
                    document.getElementById('activeUser').textContent = currentUser;
                    showDashboardScreen();
                    loadData();
                    return true;
                }
            }
            return false;
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Verificar si hay una sesión activa
            if (!checkActiveSession()) {
                showLoginScreen();
            }
            
            // Configurar event listeners para el formulario de login
            document.getElementById('loginForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const username = document.getElementById('usuario').value.trim().toLowerCase();
                const password = document.getElementById('codigo').value.trim();
                login(username, password);
            });
            
            // Configurar event listeners para los filtros
            document.getElementById('filtroDesde').addEventListener('change', applyFilters);
            document.getElementById('filtroHasta').addEventListener('change', applyFilters);
            document.getElementById('filtroFarmacia').addEventListener('change', applyFilters);
            document.getElementById('btnReset').addEventListener('click', resetFilters);
            document.getElementById('exportData').addEventListener('click', exportData);
            document.getElementById('logoutBtn').addEventListener('click', logout);
        });
    </script>
</body>
</html>
